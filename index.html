<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Rechnungskorrektur Tool</title>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f7f7f7;
    }

    h1 {
      margin-bottom: 10px;
    }

    textarea {
      width: 100%;
      height: 180px;
      font-family: monospace;
      padding: 10px;
      margin-bottom: 10px;
    }

    button {
      padding: 10px 15px;
      margin: 5px;
      cursor: pointer;
      border: none;
      border-radius: 6px;
      background: #0077cc;
      color: white;
      font-size: 14px;
    }

    button:hover {
      background: #005fa3;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background: white;
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      font-size: 14px;
    }

    th {
      background: #eee;
    }

    td.num {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    input[type="date"] {
      padding: 6px;
      font-size: 14px;
    }
  </style>
</head>

<body>

<h1>Rechnungskorrektur Tool</h1>

<!-- Oben: Debug leeren -->
<button onclick="clearDebug()">Debug-Text leeren</button>

<h3>Import Text</h3>
<textarea id="importText"></textarea>

<button onclick="parseInvoice()">Import verarbeiten</button>

<hr>

<h3>Rechnungsdaten</h3>

<label>Invoice Date:
  <input type="date" id="invoiceDate">
</label>

<br><br>

<label>Arrival:
  <input type="date" id="arrivalDate">
</label>

<label>Departure:
  <input type="date" id="departureDate">
</label>

<hr>

<h3>Positionen</h3>

<table>
  <thead>
    <tr>
      <th>Date</th>
      <th>VAT %</th>
      <th>Description</th>
      <th>Qty</th>
      <th>Unit</th>
      <th>Debit CHF</th>
      <th>Credit CHF</th>
    </tr>
  </thead>
  <tbody id="itemsBody"></tbody>
</table>

<hr>

<h3>Debug Text</h3>
<textarea id="debugText"></textarea>

<button onclick="clearDebug()">Debug-Text leeren</button>

<script>
/* -----------------------------
   Helper: Zahlenformatierung
----------------------------- */
function format2(num) {
  return Number(num).toFixed(2);
}

/* -----------------------------
   Debug leeren
----------------------------- */
function clearDebug() {
  document.getElementById("debugText").value = "";
}

/* -----------------------------
   Hauptparser
----------------------------- */
function parseInvoice() {
  let raw = document.getElementById("importText").value;
  let lines = raw.split("\n").map(l => l.trim()).filter(l => l.length);

  let debug = [];
  let items = [];

  // Suche nach Positionen (Zeilen mit Datum am Anfang)
  for (let line of lines) {

    // Beispiel: 11.02.26 Accommodation 1 100.00
    let m = line.match(/^(\d{2}\.\d{2}\.\d{2})\s+(.*)$/);

    if (!m) continue;

    let date = m[1];
    let rest = m[2];

    // Money Regex: nur Werte mit 2 Dezimalstellen!
    let moneyMatches = rest.match(/\d+\.\d{2}/g);

    if (!moneyMatches) continue;

    // Letzter Betrag ist immer Amount
    let amount = moneyMatches[moneyMatches.length - 1];

    // Qty erkennen: einzelne Zahl ohne Dezimalen
    let qtyMatch = rest.match(/\s(\d+)\s+\d+\.\d{2}$/);
    let qty = qtyMatch ? qtyMatch[1] : "1";

    // Beschreibung = alles zwischen Datum und Qty
    let desc = rest
      .replace(/\s+\d+\s+\d+\.\d{2}$/, "")
      .trim();

    // VAT Default
    let vat = "3.8";

    // Sonderregeln
    if (desc.toLowerCase().includes("parking")) {
      vat = "8.1";
    }
    if (desc.toLowerCase().includes("room hire")) {
      vat = "8.1";
    }

    // Debit/Credit Entscheidung
    let debit = "0.00";
    let credit = "0.00";

    if (desc.toLowerCase().includes("mastercard") ||
        desc.toLowerCase().includes("visa") ||
        desc.toLowerCase().includes("payment") ||
        desc.toLowerCase().includes("eurocard")) {
      credit = format2(amount);
    } else {
      debit = format2(amount);
    }

    items.push({
      date,
      vat,
      desc,
      qty,
      unit: "",
      debit,
      credit
    });

    debug.push("Parsed: " + JSON.stringify(items[items.length - 1]));
  }

  document.getElementById("debugText").value = debug.join("\n");

  renderItems(items);
}

/* -----------------------------
   Render Tabelle
----------------------------- */
function renderItems(items) {
  let body = document.getElementById("itemsBody");
  body.innerHTML = "";

  for (let it of items) {
    let tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${it.date}</td>
      <td class="num">${it.vat}</td>
      <td>${it.desc}</td>
      <td class="num">${it.qty}</td>
      <td>${it.unit}</td>
      <td class="num">${format2(it.debit)}</td>
      <td class="num">${format2(it.credit)}</td>
    `;

    body.appendChild(tr);
  }
}
</script>

</body>
</html>
