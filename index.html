<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rechnungskorrektur – PDF Import (Spalten-Fix + Adressen) + PDF Export</title>

  <style>
    :root{
      --ink:#111;
      --muted:#666;
      --line:#d9d9d9;
      --bg:#fafafa;
      --card:#fff;
      --accent:#1d4ed8;
      --ok:#0f766e;
      --warn:#b45309;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font: 13px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial; color:var(--ink); background:var(--bg); }

    header{
      background:var(--card);
      border-bottom:1px solid var(--line);
      padding:14px 18px;
      display:flex; gap:12px; align-items:center; flex-wrap:wrap;
    }
    header h1{ font-size:14px; margin:0; font-weight:800; letter-spacing:.2px; }
    .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-left:auto; }
    .btn{
      border:1px solid var(--line);
      background:var(--card);
      padding:8px 10px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
      white-space:nowrap;
      user-select:none;
    }
    .btn.primary{ background:var(--accent); color:#fff; border-color:transparent; }
    .btn.success{ background:var(--ok); color:#fff; border-color:transparent; }
    .btn:active{ transform: translateY(1px); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; transform:none; }

    input[type="file"]{
      position:absolute;
      left:-9999px;
      width:1px; height:1px;
      opacity:0;
    }

    main{
      padding:14px;
      max-width: 1100px;
      margin:0 auto;
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      box-shadow: 0 1px 0 rgba(0,0,0,.03);
      overflow:hidden;
    }
    .card .hd{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card .hd strong{ font-size:13px; }
    .card .bd{ padding:14px; }

    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .grid3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
    @media (max-width: 700px){ .grid2,.grid3{ grid-template-columns:1fr; } }

    label{ display:block; font-size:11px; color:var(--muted); margin-bottom:6px; }
    .field{
      border:1px solid var(--line);
      border-radius:10px;
      padding:9px 10px;
      width:100%;
      background:#fff;
      outline:none;
      font: inherit;
    }
    textarea.field{ min-height: 86px; resize: vertical; }
    .field:focus{ border-color:#c7d2fe; box-shadow:0 0 0 3px rgba(99,102,241,.15); }

    table{ width:100%; border-collapse:collapse; font-size:12px; }
    thead th{
      text-align:left; font-size:11px; color:var(--muted);
      padding:8px 8px; border-bottom:1px solid var(--line);
      background:#fff; position:sticky; top:0; z-index:1;
    }
    tbody td{ padding:6px 6px; border-bottom:1px solid #eee; vertical-align:top; }
    tbody tr:hover{ background:#fcfcff; }
    .num{ text-align:right; }
    .right{ text-align:right; }
    .muted{ color:var(--muted); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .rowinput{
      width:100%;
      border:1px solid #eee;
      border-radius:8px;
      padding:6px 8px;
      outline:none;
      background:#fff;
      font: inherit;
    }
    .rowinput:focus{ border-color:#c7d2fe; box-shadow:0 0 0 3px rgba(99,102,241,.15); }
    .toggle{
      display:flex; align-items:center; justify-content:center;
      gap:6px;
    }
    .toggle input{ transform: scale(1.05); }

    .hint{ font-size:11px; color:var(--muted); }

    .totals{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .totals .box{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      background:#fff;
    }
    .totals .box .k{ font-size:11px; color:var(--muted); }
    .totals .box .v{ font-size:16px; font-weight:900; margin-top:4px; }

    .statusBar{
      border:1px solid #f0f0f0;
      border-radius:12px;
      padding:10px;
      background:#fff;
      display:flex;
      flex-wrap:wrap;
      gap:10px 14px;
      align-items:center;
      margin-top:12px;
    }
    .statusPill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border:1px solid #eee;
      border-radius:999px;
      font-size:12px;
      background:#fff;
      color:var(--muted);
    }
    .statusPill.ok{ color:var(--ok); border-color:#d1fae5; }
    .statusPill.warn{ color:var(--warn); border-color:#ffedd5; }
    .statusPill b{ color:inherit; }

    .invoicePaper{
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      padding:16px;
    }

    .invoiceHeader{
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:16px;
      align-items:start;
      border-bottom:1px solid #eee;
      padding-bottom:12px;
      margin-bottom:12px;
    }
    @media (max-width: 900px){
      .invoiceHeader{ grid-template-columns: 1fr; }
    }

    .brandRow{
      display:grid;
      grid-template-columns: 180px 1fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 700px){
      .brandRow{ grid-template-columns: 1fr; }
    }

    .logoBox{
      width:180px;
      height:80px;
      border:1px solid #eee;
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      background:#fff;
    }
    .logoBox img{ max-width:100%; max-height:100%; object-fit:contain; display:block; }
    .sellerHead{
      border:1px solid #f0f0f0;
      border-radius:12px;
      padding:10px;
      background:#fff;
      white-space:pre-wrap;
      font-weight:700;
    }
    .sellerHead .small{ font-weight:600; color:var(--muted); margin-top:6px; }

    .meta{
      display:grid;
      grid-template-columns: 1fr;
      gap:8px;
    }
    .meta .kv{
      display:flex;
      justify-content:space-between;
      gap:10px;
      border:1px solid #f0f0f0;
      border-radius:10px;
      padding:8px 10px;
      background:#fff;
    }
    .meta .kv b{ font-weight:800; }
    .meta .kv span{ color:var(--muted); }

    .blocks{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-bottom:10px;
    }
    @media (max-width: 700px){
      .blocks{ grid-template-columns: 1fr; }
    }

    .block{
      border:1px solid #eee;
      border-radius:12px;
      padding:10px;
      background:#fff;
      min-height:90px;
    }
    .block .t{ font-size:11px; color:var(--muted); margin-bottom:6px; }
    .block .v{ font-weight:700; white-space:pre-wrap; }

    .paperTable th, .paperTable td{ padding:6px 6px; border-bottom:1px solid #eee; }
    .paperTable thead th{ position:static; top:auto; }

    .paperFooter{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 900px){
      .paperFooter{ grid-template-columns: 1fr; }
    }

    .paperTotals{
      border:1px solid #eee;
      border-radius:12px;
      padding:10px;
    }
    .paperTotals .line{
      display:flex; justify-content:space-between; gap:10px; padding:4px 0;
    }
    .paperTotals .line b{ font-weight:900; }

    .paperVat{
      border:1px solid #eee;
      border-radius:12px;
      padding:10px;
    }

    .paperLegal{
      margin-top:12px;
      border-top:1px solid #eee;
      padding-top:10px;
      font-size:11px;
      color:var(--muted);
      line-height:1.35;
      white-space:pre-wrap;
    }

    details summary{
      cursor:pointer;
      font-weight:800;
    }

    @media print{
      body{ background:#fff; }
      header, .noPrint{ display:none !important; }
      main{ display:block; padding:0; margin:0; max-width:none; }
      .card{ border:none; box-shadow:none; }
      .invoicePaper{ border:none; border-radius:0; padding:0; }
      @page{ size:A4; margin:12mm; }
    }
  </style>
</head>

<body>
<header>
  <h1>Rechnungskorrektur: PDF Import (Spalten-Fix + Adressen) • MwSt pro Position • Export</h1>

  <div class="toolbar">
    <label class="btn primary" for="pdfFile">PDF importieren</label>
    <input id="pdfFile" type="file" accept="application/pdf" />

    <button class="btn" id="manualImportBtn" type="button" title="Fallback, wenn PDF.js blockiert ist">
      Import per Text (Fallback)
    </button>

    <button class="btn" id="addRowBtn" type="button">+ Position</button>

    <button class="btn" id="printBtn" type="button">Drucken / Als PDF speichern</button>
    <button class="btn success" id="exportPdfBtn" type="button">Finale PDF exportieren</button>

    <button class="btn" id="exportJsonBtn" type="button">Export JSON</button>
    <label class="btn" for="importJson">JSON import</label>
    <input id="importJson" type="file" accept="application/json" />
  </div>
</header>

<main>
  <section class="card">
    <div class="hd">
      <strong>Editor</strong>
      <span class="hint">Fix gegen „Verrutschen“: Tabellen-Zeilen werden direkt aus PDF-Spalten (X-Positionen) gelesen. Adressen werden ebenfalls aus dem Kopfbereich erkannt.</span>
    </div>

    <div class="bd">
      <div class="grid3">
        <div>
          <label>Hotel / Firma</label>
          <input id="sellerName" class="field" value="ibis Zurich Messe Airport" />
        </div>
        <div>
          <label>Kontakt / Web (Kopfzeile)</label>
          <input id="sellerContact" class="field" value="+41 44 307 47 00 | H2980@accor.com | www.all.accor.com" />
        </div>
        <div>
          <label>Optionale Zusatzzeile</label>
          <input id="sellerExtra" class="field" value="" />
        </div>
      </div>

      <div style="height:10px;"></div>

      <div>
        <label>Adresse Verkäufer (ein Feld)</label>
        <textarea id="sellerAddressBlock" class="field">Heidi Abel-Weg 5
CH-8050 ZURICH
Switzerland</textarea>
      </div>

      <div style="height:14px;"></div>

      <div class="grid2">
        <div>
          <label>Kunde</label>
          <input id="buyerName" class="field" value="BEY TOURS" />
        </div>
        <div>
          <label>Referenz / Gastname</label>
          <input id="reference" class="field" value="Beytours 12019-1338" />
        </div>
      </div>

      <div style="height:10px;"></div>

      <div>
        <label>Adresse Kunde (ein Feld)</label>
        <textarea id="buyerAddressBlock" class="field">DMC - Incoming France
35 rue d'Hauteville
75010 Paris
France</textarea>
      </div>

      <div style="height:14px;"></div>

      <div class="grid3">
        <div>
          <label>Invoice No.</label>
          <input id="invoiceNo" class="field" value="39498" />
        </div>
        <div>
          <label>Rechnungsdatum</label>
          <input id="invoiceDate" class="field" value="05.01.2026" />
        </div>
        <div>
          <label>Währung</label>
          <input id="currency" class="field" value="CHF" />
        </div>
      </div>

      <div style="height:10px;"></div>

      <div class="grid3">
        <div>
          <label>Anreise</label>
          <input id="arrival" class="field" value="02.01.2026" />
        </div>
        <div>
          <label>Abreise</label>
          <input id="departure" class="field" value="05.01.2026" />
        </div>
        <div>
          <label>Zimmer / Reservation</label>
          <input id="roomReservation" class="field" value="Room 9295 | Reservation 594489457" />
        </div>
      </div>

      <div class="statusBar">
        <span class="statusPill" id="importPill"><b>Import:</b> —</span>
        <span class="statusPill" id="workerPill"><b>PDF.js:</b> —</span>
        <span class="statusPill" id="exportPill"><b>Export:</b> —</span>
        <span class="hint" id="importHint">
          Wenn PDF-Import blockiert ist: „Import per Text (Fallback)“ (PDF öffnen → Text markieren → kopieren → einfügen).
        </span>
      </div>

      <div style="height:14px;"></div>

      <div class="card" style="border-radius:12px;">
        <div class="hd">
          <strong>Positionen</strong>
          <span class="hint">QTY × Unit → Debit (wenn Debit leer). MwSt je Zeile wählbar.</span>
        </div>
        <div class="bd" style="padding:0;">
          <div style="max-height:340px; overflow:auto;">
            <table id="itemsTable">
              <thead>
                <tr>
                  <th style="width:110px;">Datum</th>
                  <th>Beschreibung</th>
                  <th class="num" style="width:70px;">QTY</th>
                  <th class="num" style="width:90px;">Unit</th>
                  <th class="num" style="width:110px;">Debit</th>
                  <th class="num" style="width:110px;">Credit</th>
                  <th class="num" style="width:92px;">MwSt %</th>
                  <th style="width:86px;">MwSt?</th>
                  <th style="width:70px;"></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div style="height:14px;"></div>

      <div class="totals">
        <div class="box">
          <div class="k">Total Debit</div>
          <div class="v mono" id="totalDebit">0.00</div>
        </div>
        <div class="box">
          <div class="k">Total Credit</div>
          <div class="v mono" id="totalCredit">0.00</div>
        </div>
        <div class="box">
          <div class="k">Saldo (Debit − Credit)</div>
          <div class="v mono" id="balance">0.00</div>
        </div>
        <div class="box">
          <div class="k">Endbetrag / Total</div>
          <div class="v mono" id="grandTotal">0.00</div>
        </div>
      </div>

      <div style="height:14px;"></div>

      <div class="card" style="border-radius:12px;">
        <div class="hd">
          <strong>MwSt-Aufschlüsselung (pro Satz)</strong>
          <span class="hint">Steuerbasis je Satz = Summe steuerbarer Zeilen (Debit − Credit).</span>
        </div>
        <div class="bd">
          <table id="vatBreakdownTable">
            <thead>
              <tr>
                <th>MwSt %</th>
                <th class="num">Netto</th>
                <th class="num">MwSt</th>
                <th class="num">Brutto</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="hint" style="margin-top:8px;">
            Logik: Zeile hat „MwSt?“ an/aus + MwSt-%. Credits reduzieren die Basis.
          </div>
        </div>
      </div>

      <div style="height:18px;"></div>

      <div class="invoicePaper" id="invoicePaper">
        <div class="invoiceHeader">
          <div>
            <div class="brandRow">
              <div class="logoBox" title="Logo (lokal im Repo)">
                <img id="logoImg"
                     src="Logo_ibis_RGB.png"
                     alt="Logo ibis"
                     crossorigin="anonymous"
                     referrerpolicy="no-referrer"
                     onerror="this.style.display='none';document.getElementById('logoFallback').style.display='block';" />
                <div id="logoFallback" class="muted" style="display:none;text-align:center;padding:8px;">
                  ibis<br><span class="hint">Logo konnte nicht geladen werden</span>
                </div>
              </div>

              <div class="sellerHead">
                <div id="p_sellerHeadMain"></div>
                <div class="small" id="p_sellerHeadContact"></div>
              </div>
            </div>
          </div>

          <div>
            <div style="font-weight:900;font-size:16px;margin-bottom:6px;">INVOICE</div>
            <div class="meta">
              <div class="kv"><span>Invoice No.</span><b id="p_invoiceNo">—</b></div>
              <div class="kv"><span>Date</span><b id="p_invoiceDate">—</b></div>
              <div class="kv"><span>Arrival</span><b id="p_arrival">—</b></div>
              <div class="kv"><span>Departure</span><b id="p_departure">—</b></div>
              <div class="kv"><span>Room / Reservation</span><b id="p_roomRes">—</b></div>
              <div class="kv"><span>Currency</span><b id="p_currency">—</b></div>
            </div>
          </div>
        </div>

        <div class="blocks">
          <div class="block">
            <div class="t">From</div>
            <div class="v" id="p_seller"></div>
          </div>
          <div class="block">
            <div class="t">To</div>
            <div class="v" id="p_buyer"></div>
          </div>
        </div>

        <div class="block" style="margin-bottom:12px;">
          <div class="t">Reference</div>
          <div class="v" id="p_reference"></div>
        </div>

        <table class="paperTable">
          <thead>
            <tr>
              <th style="width:90px;">Date</th>
              <th>Description</th>
              <th class="num" style="width:60px;">QTY</th>
              <th class="num" style="width:90px;">Unit</th>
              <th class="num" style="width:100px;">Debit</th>
              <th class="num" style="width:100px;">Credit</th>
              <th class="num" style="width:70px;">VAT%</th>
            </tr>
          </thead>
          <tbody id="p_items"></tbody>
        </table>

        <div class="paperFooter">
          <div class="paperVat">
            <div style="font-weight:900;margin-bottom:6px;">VAT Breakdown</div>
            <table style="width:100%; border-collapse:collapse; font-size:12px;">
              <thead>
                <tr>
                  <th style="text-align:left;color:var(--muted);font-size:11px;border-bottom:1px solid #eee;padding:6px 4px;">VAT%</th>
                  <th class="num" style="color:var(--muted);font-size:11px;border-bottom:1px solid #eee;padding:6px 4px;">Net</th>
                  <th class="num" style="color:var(--muted);font-size:11px;border-bottom:1px solid #eee;padding:6px 4px;">VAT</th>
                  <th class="num" style="color:var(--muted);font-size:11px;border-bottom:1px solid #eee;padding:6px 4px;">Gross</th>
                </tr>
              </thead>
              <tbody id="p_vatRows"></tbody>
            </table>
          </div>

          <div class="paperTotals">
            <div style="font-weight:900;margin-bottom:6px;">Totals</div>
            <div class="line"><span>Total Debit</span><b class="mono" id="p_totalDebit">—</b></div>
            <div class="line"><span>Total Credit</span><b class="mono" id="p_totalCredit">—</b></div>
            <div class="line" style="border-top:1px solid #eee;margin-top:6px;padding-top:8px;">
              <span>Balance</span><b class="mono" id="p_balance">—</b>
            </div>
          </div>
        </div>

        <div class="paperLegal" id="p_legalFooter"></div>
      </div>

      <div class="noPrint" style="margin-top:10px;">
        <div class="hint">
          Für PDF: entweder „Drucken / Als PDF speichern“ oder „Finale PDF exportieren“. Falls Export blockiert ist → Drucken nutzen.
        </div>
      </div>

      <div style="height:14px;"></div>

      <div class="card" style="border-radius:12px;">
        <div class="hd">
          <strong>Fußzeile / Bankdaten / Rechtstext (wird gedruckt)</strong>
          <span class="hint">Hier Bankdaten / Zahlungsziel etc. eintragen.</span>
        </div>
        <div class="bd">
          <label>Footer-Text</label>
          <textarea id="legalFooter" class="field">Essendi Switzerland SA (ehem. AccorInvest)
[Bank / IBAN / BIC / Konto / Zahlungsziel etc. hier einfügen]
Weitere Informationen / rechtliche Angaben …</textarea>
        </div>
      </div>

      <div style="height:14px;"></div>

      <details class="card" style="border-radius:12px;">
        <summary class="hd">
          <strong>Import-Text (Debug) anzeigen</strong>
          <span class="hint">Hier siehst du den aus dem PDF gelesenen Text (oder den eingefügten Fallback-Text).</span>
        </summary>
        <div class="bd">
          <label>Ausgelesener / eingefügter Text</label>
          <textarea id="extractedText" class="field mono" style="min-height:240px;" placeholder="Nach PDF-Import erscheint hier der Text …"></textarea>
          <div class="hint" style="margin-top:8px;">
            Wenn PDF-Import blockiert ist: PDF öffnen → Text markieren → kopieren → „Import per Text (Fallback)“.
          </div>
        </div>
      </details>

    </div>
  </section>
</main>

<script>
  // -----------------------------
  // CDN Kandidaten
  // -----------------------------
  const LIBS = {
    pdfjs: [
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.min.js",
      "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.10.38/build/pdf.min.js",
      "https://unpkg.com/pdfjs-dist@4.10.38/build/pdf.min.js",
    ],
    pdfjsWorker: [
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.worker.min.js",
      "https://cdn.jsdelivr.net/npm/pdfjs-dist@4.10.38/build/pdf.worker.min.js",
      "https://unpkg.com/pdfjs-dist@4.10.38/build/pdf.worker.min.js",
    ],
    html2canvas: [
      "https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js",
      "https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js",
      "https://unpkg.com/html2canvas@1.4.1/dist/html2canvas.min.js",
    ],
    jspdf: [
      "https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js",
      "https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js",
      "https://unpkg.com/jspdf@2.5.1/dist/jspdf.umd.min.js",
    ]
  };

  const loadedScripts = new Set();
  function loadScriptOnce(url){
    return new Promise((resolve, reject) => {
      if (loadedScripts.has(url)) return resolve(true);
      const s = document.createElement("script");
      s.src = url;
      s.async = true;
      s.onload = () => { loadedScripts.add(url); resolve(true); };
      s.onerror = () => reject(new Error("Script load failed: " + url));
      document.head.appendChild(s);
    });
  }
  async function loadAny(candidates){
    for (const url of candidates){
      try{ await loadScriptOnce(url); return url; }
      catch (e){ console.warn(e); }
    }
    return "";
  }

  // -----------------------------
  // State
  // -----------------------------
  const state = {
    items: [
      { date: "02.01.26", desc: "Accommodation", qty: 2, unit: 135.00, debit: "", credit: "", vatRate: 3.8, vatEnabled: true },
      { date: "02.01.26", desc: "City Tax", qty: 46, unit: 3.50, debit: "", credit: "", vatRate: 0.0, vatEnabled: false },
      { date: "02.01.26", desc: "Deposit Transfered", qty: 1, unit: 2467.00, debit: "", credit: 2467.00, vatRate: 0.0, vatEnabled: false },
    ]
  };

  // -----------------------------
  // Helpers
  // -----------------------------
  function toNumber(val){
    if (val === null || val === undefined) return 0;
    if (typeof val === "number") return isFinite(val) ? val : 0;

    let s = String(val).trim();
    if (!s) return 0;

    // remove spaces/thousand separators
    s = s.replace(/\s/g,"").replace(/’/g,"").replace(/'/g,"").replace(/\u00A0/g,"");

    const hasDot = s.includes(".");
    const hasComma = s.includes(",");
    if (hasDot && hasComma){
      const lastDot = s.lastIndexOf(".");
      const lastComma = s.lastIndexOf(",");
      const decIsComma = lastComma > lastDot;
      if (decIsComma){
        s = s.replace(/\./g,"").replace(",",".");
      } else {
        s = s.replace(/,/g,"");
      }
    } else if (hasComma && !hasDot){
      s = s.replace(",",".");
    } else {
      s = s.replace(/,/g,"");
    }

    const n = parseFloat(s);
    return isFinite(n) ? n : 0;
  }
  function round2(n){ return Math.round(n*100)/100; }

  function fmt(n){
    const cur = document.getElementById("currency").value || "CHF";
    return `${round2(n).toFixed(2)} ${cur}`;
  }
  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function setPill(id, text, kind){
    const el = document.getElementById(id);
    if (!el) return;
    el.classList.remove("ok","warn");
    if (kind) el.classList.add(kind);
    el.innerHTML = text;
  }
  function normalizeText(t){
    return (t || "")
      .replace(/\r/g,"")
      .replace(/[ \t]+\n/g,"\n")
      .replace(/\n{3,}/g,"\n\n")
      .trim();
  }
  function v(id){ return document.getElementById(id).value; }
  function setV(id, val){ document.getElementById(id).value = val; }
  function setText(id, val){
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent = val;
  }

  function normDate(d){
    return String(d||"").replace(/\//g,".").replace(/^(\d{2}\.\d{2}\.)(\d{2})$/, "$120$2");
  }

  // -----------------------------
  // PDF.js loader
  // -----------------------------
  async function ensurePdfJsReady(){
    if (window.pdfjsLib) return true;

    setPill("workerPill", "<b>PDF.js:</b> laden…", "");
    const url = await loadAny(LIBS.pdfjs);

    if (!url || !window.pdfjsLib){
      setPill("workerPill", "<b>PDF.js:</b> blockiert – Text-Fallback nutzen", "warn");
      return false;
    }

    const workerUrl = await loadAny(LIBS.pdfjsWorker);
    try{
      if (workerUrl && window.pdfjsLib?.GlobalWorkerOptions){
        pdfjsLib.GlobalWorkerOptions.workerSrc = workerUrl;
        setPill("workerPill", "<b>PDF.js:</b> geladen (Worker)", "ok");
      } else {
        setPill("workerPill", "<b>PDF.js:</b> geladen (ohne Worker)", "warn");
      }
    } catch (e){
      console.warn("Worker set failed:", e);
      setPill("workerPill", "<b>PDF.js:</b> geladen (Fallback)", "warn");
    }
    return true;
  }

  // -----------------------------
  // Export libs
  // -----------------------------
  async function ensureExportLibs(){
    if (!window.html2canvas){
      setPill("exportPill", "<b>Export:</b> html2canvas laden…", "");
      await loadAny(LIBS.html2canvas);
    }
    if (!window.jspdf){
      setPill("exportPill", "<b>Export:</b> jsPDF laden…", "");
      await loadAny(LIBS.jspdf);
    }
    const ok = !!window.html2canvas && !!window.jspdf?.jsPDF;
    setPill("exportPill", ok ? "<b>Export:</b> bereit" : "<b>Export:</b> blockiert (Drucken nutzen)", ok ? "ok" : "warn");
    return ok;
  }

  // -----------------------------
  // PDF -> Rows (Y grouping) with fragments (x,str)
  // -----------------------------
  async function pageToRows(page){
    const content = await page.getTextContent({ disableCombineTextItems: false });
    const rows = new Map();
    const Y_TOL = 2.0;

    for (const it of content.items){
      const str = String(it.str ?? "").replace(/\s+/g," ").trim();
      if (!str) continue;
      const tx = it.transform;
      const x = tx[4];
      const y = tx[5];
      const yKey = Math.round(y / Y_TOL) * Y_TOL;

      if (!rows.has(yKey)) rows.set(yKey, []);
      rows.get(yKey).push({ x, str });
    }

    const yKeys = Array.from(rows.keys()).sort((a,b)=> b-a);
    return yKeys.map(y => ({
      y,
      parts: rows.get(y).sort((a,b)=> a.x-b.x)
    }));
  }

  // join a row into plain text (good for header/address)
  function rowToText(parts){
    let out = "";
    let lastX = null;
    for (const p of parts){
      const gap = lastX === null ? 0 : (p.x - lastX);
      out += out ? (gap > 18 ? "  " : " ") : "";
      out += p.str;
      lastX = p.x;
    }
    return out.trim();
  }

  // numeric fragment glue: if both are numeric-ish, concatenate (e.g. "3" + ",167.50")
  function glueIfNumeric(a, b){
    const A = String(a||"").trim();
    const B = String(b||"").trim();
    if (!A) return B;
    if (!B) return A;
    const numish = (s)=> /^[\(\-]?\d[\d.,']*\)?$/.test(s);
    if (numish(A) && numish(B)) return A + B;
    return A + " " + B;
  }

  // -----------------------------
  // Detect table header columns dynamically (Date / VAT / Description / Qty / Debit / Credit)
  // and parse the table rows by X ranges (NO "verrutschen")
  // -----------------------------
  function findTableHeaderAndBounds(allRows){
    // Find row containing the table header
    // Typical: "Date  VAT  Description  Qty.  Debit CHF  Credit CHF"
    for (const r of allRows){
      const t = rowToText(r.parts).toLowerCase();
      if (t.includes("date") && t.includes("description") && (t.includes("debit") || t.includes("debit chf")) && (t.includes("credit") || t.includes("credit chf"))){
        // Collect x positions for each header token
        const getX = (regexList) => {
          let best = null;
          for (const p of r.parts){
            const s = p.str.toLowerCase();
            for (const re of regexList){
              if (re.test(s)){
                best = (best === null) ? p.x : Math.min(best, p.x);
              }
            }
          }
          return best;
        };

        const xDate = getX([/^date$/i, /^date\b/i]);
        const xVAT  = getX([/^vat$/i, /^vat\b/i]);
        const xDesc = getX([/^description$/i, /^description\b/i]);
        const xQty  = getX([/^qty/i, /^qty\./i]);
        const xDebit = getX([/^debit/i]);
        const xCredit = getX([/^credit/i]);

        // If something missing, still proceed with available ones
        const xs = [
          {k:"date", x:xDate},
          {k:"vat", x:xVAT},
          {k:"desc", x:xDesc},
          {k:"qty", x:xQty},
          {k:"debit", x:xDebit},
          {k:"credit", x:xCredit},
        ].filter(o => typeof o.x === "number" && isFinite(o.x)).sort((a,b)=>a.x-b.x);

        if (xs.length < 4) continue;

        // build bounds midpoints between x starts
        const bounds = [];
        for (let i=0;i<xs.length;i++){
          const cur = xs[i];
          const next = xs[i+1];
          const start = cur.x - 1;
          const end = next ? (cur.x + next.x)/2 : 1e9;
          bounds.push({ k: cur.k, start, end });
        }
        return { headerY: r.y, bounds };
      }
    }
    return null;
  }

  function parseMoney(str){
    let s = String(str||"").trim();
    if (!s) return "";
    const isParens = /^\(.*\)$/.test(s);
    s = s.replace(/[()]/g,"").replace(/[^\d,.\-’'\u00A0 ]/g,"");
    const n = toNumber(s);
    if (!isFinite(n) || n === 0) return "";
    return isParens ? -Math.abs(n) : n;
  }

  function parseQty(str){
    const s = String(str||"").trim();
    if (!s) return "";
    if (/^\d{1,6}$/.test(s)) return toNumber(s);
    return "";
  }

  function isCreditDesc(desc){
    return /(deposit|advance|prepayment|transfer|paid|payment|voucher|refund|credit)/i.test(desc);
  }
  function isCityTaxDesc(desc){
    return /(city\s*tax|tourist\s*tax|taxe\s*de\s*s[eé]jour|kurtaxe)/i.test(desc);
  }

  function parseIbisTableFromRows(allRows, defaultVatRate){
    const hdr = findTableHeaderAndBounds(allRows);
    if (!hdr) return [];

    const dateStartRe = /^(\d{2}[.\/]\d{2}[.\/](?:\d{2}|\d{4}))$/;

    const items = [];
    let inTable = false;

    for (const r of allRows){
      if (!inTable){
        if (r.y === hdr.headerY) inTable = true;
        continue;
      }

      // Stop conditions: next section header "Date Deposit Invoice No." or "VAT Breakdown" etc.
      const rowText = rowToText(r.parts).toLowerCase();
      if (rowText.includes("vat breakdown") || rowText.includes("deposit invoice") || rowText.includes("balance") || rowText.includes("total chf")){
        break;
      }

      // Split row into columns by bounds using X positions
      const col = { date:"", vat:"", desc:"", qty:"", debit:"", credit:"" };

      // assign fragments to bucket by x
      for (const p of r.parts){
        const b = hdr.bounds.find(bb => p.x >= bb.start && p.x < bb.end);
        if (!b) continue;
        const key = b.k;
        // glue inside same column (important for "3" + ",167.50")
        col[key] = col[key] ? glueIfNumeric(col[key], p.str) : p.str;
      }

      const date = String(col.date||"").trim();
      if (!dateStartRe.test(date)) continue; // only real item rows

      let desc = String(col.desc||"").trim();
      let qty = parseQty(col.qty);
      let debit = parseMoney(col.debit);
      let credit = parseMoney(col.credit);

      // If debit empty but credit exists -> ok
      // If debit negative -> move to credit (common for adjustments)
      if (debit !== "" && Number(debit) < 0){
        credit = Math.abs(Number(debit));
        debit = "";
      }

      // If description empty but VAT bucket accidentally holds it
      if (!desc && col.vat && /[A-Za-z]/.test(col.vat)) desc = String(col.vat).trim();

      const creditLike = isCreditDesc(desc);
      const city = isCityTaxDesc(desc);

      // If it's a deposit line, prefer credit column; if only debit got filled, treat as credit
      if (creditLike){
        if (credit === "" && debit !== "") { credit = Math.abs(Number(debit)); debit = ""; }
      }

      // unit: derive if qty & (debit or credit) exist and unit blank
      let unit = "";
      const amount = (debit !== "" ? Math.abs(Number(debit)) : (credit !== "" ? Math.abs(Number(credit)) : 0));
      if (qty && amount) unit = round2(amount / qty);

      items.push({
        date: normDate(date),
        desc,
        qty: qty === "" ? "" : qty,
        unit: unit === "" ? "" : unit,
        debit: creditLike ? "" : (debit === "" ? "" : Math.abs(Number(debit))),
        credit: creditLike ? (credit === "" ? "" : Math.abs(Number(credit))) : (credit === "" ? "" : Math.abs(Number(credit))),
        vatRate: city ? 0.0 : defaultVatRate,
        vatEnabled: city ? false : true
      });
    }

    return items;
  }

  // -----------------------------
  // Address extraction (seller + buyer) from header region
  // Works well for ibis-like layout
  // -----------------------------
  function extractHeaderBlocks(allRows){
    const lines = allRows.map(r => rowToText(r.parts)).filter(Boolean);

    // Seller: find line containing "ibis" and "zurich" (or hotel name), then take next address lines
    let sellerName = "";
    let sellerAddr = [];
    let sellerContact = [];

    let sellerIdx = -1;
    for (let i=0;i<lines.length;i++){
      const L = lines[i];
      const low = L.toLowerCase();
      if (low.includes("ibis") && (low.includes("zurich") || low.includes("messe") || low.includes("airport"))){
        sellerIdx = i;
        sellerName = L.trim();
        break;
      }
    }
    if (sellerIdx >= 0){
      // collect next ~6 lines until "INVOICE" block starts or until too far
      for (let j=sellerIdx+1; j<Math.min(lines.length, sellerIdx+10); j++){
        const low = lines[j].toLowerCase();
        if (low.includes("invoice") || low.includes("invoice no") || low === "invoice") break;

        // contact-ish
        if (low.includes("telephone") || low.includes("tel") || low.includes("fax") || low.includes("@") || low.includes("www")){
          sellerContact.push(lines[j].trim());
          continue;
        }

        // address-ish
        if (lines[j].trim()){
          sellerAddr.push(lines[j].trim());
        }
      }
    }

    // Buyer: take the first block on left that looks like company + address before "INVOICE"
    // Heuristic: first non-empty block before "INVOICE" that is not the seller line
    let buyerName = "";
    let buyerAddr = [];
    const invoiceIdx = lines.findIndex(l => l.trim().toLowerCase() === "invoice");
    const scanEnd = invoiceIdx > 0 ? invoiceIdx : Math.min(lines.length, 40);

    // find a line that looks like a company name (has letters and often uppercase / S.L. / SA / GmbH etc)
    let buyerStart = -1;
    for (let i=0;i<scanEnd;i++){
      const L = lines[i].trim();
      if (!L) continue;
      const low = L.toLowerCase();
      if (sellerName && L === sellerName) continue;
      if (low.includes("ibis") && (low.includes("zurich") || low.includes("messe") || low.includes("airport"))) continue;

      const looksCompany =
        /[A-Za-z]/.test(L) &&
        (/[A-Z]{2,}/.test(L) || /\b(s\.l\.|sa|gmbh|ag|ltd|inc|sarl|llc)\b/i.test(L));

      if (looksCompany){
        buyerStart = i;
        buyerName = L;
        break;
      }
    }
    if (buyerStart >= 0){
      for (let j=buyerStart+1; j<scanEnd; j++){
        const L = lines[j].trim();
        if (!L) break;
        const low = L.toLowerCase();
        if (low.includes("invoice")) break;
        // keep VAT/TVA lines inside address block too (user wanted address imported)
        buyerAddr.push(L);
        // stop if we hit the invoice meta labels area
        if (low.startsWith("invoice no") || low.startsWith("arrival") || low.startsWith("departure")) break;
      }
    }

    // Normalize seller contact into one line
    const sellerContactLine = sellerContact
      .join(" | ")
      .replace(/\s*\|\s*\|\s*/g," | ")
      .trim();

    return {
      sellerName: sellerName || "",
      sellerAddressBlock: sellerAddr.join("\n").trim(),
      sellerContact: sellerContactLine,
      buyerName: buyerName || "",
      buyerAddressBlock: buyerAddr.join("\n").trim()
    };
  }

  // -----------------------------
  // Items table render
  // -----------------------------
  const tbody = document.querySelector("#itemsTable tbody");

  function renderItems(){
    tbody.innerHTML = "";
    state.items.forEach((it, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input class="rowinput mono" value="${escapeHtml(it.date ?? "")}" data-k="date" data-i="${idx}"></td>
        <td><input class="rowinput" value="${escapeHtml(it.desc ?? "")}" data-k="desc" data-i="${idx}"></td>
        <td class="num"><input class="rowinput right mono" value="${escapeHtml(it.qty ?? "")}" data-k="qty" data-i="${idx}" inputmode="decimal"></td>
        <td class="num"><input class="rowinput right mono" value="${escapeHtml(it.unit ?? "")}" data-k="unit" data-i="${idx}" inputmode="decimal"></td>
        <td class="num"><input class="rowinput right mono" value="${escapeHtml(it.debit ?? "")}" data-k="debit" data-i="${idx}" inputmode="decimal"></td>
        <td class="num"><input class="rowinput right mono" value="${escapeHtml(it.credit ?? "")}" data-k="credit" data-i="${idx}" inputmode="decimal"></td>
        <td class="num">
          <input class="rowinput right mono" value="${escapeHtml(it.vatRate ?? 0)}" data-k="vatRate" data-i="${idx}" inputmode="decimal" title="MwSt % für diese Position">
        </td>
        <td class="toggle">
          <label style="margin:0;display:flex;align-items:center;gap:6px;">
            <input type="checkbox" ${it.vatEnabled ? "checked":""} data-k="vatEnabled" data-i="${idx}">
            <span class="hint">Ja</span>
          </label>
        </td>
        <td class="right"><button class="btn" type="button" data-del="${idx}">✕</button></td>
      `;
      tbody.appendChild(tr);
    });
    recalc();
  }

  tbody.addEventListener("input", (e) => {
    const el = e.target;
    if (!el.dataset || el.dataset.i === undefined) return;
    const i = parseInt(el.dataset.i, 10);
    const k = el.dataset.k;
    if (!state.items[i]) return;

    let vv = el.value;

    if (["qty","unit","debit","credit","vatRate"].includes(k)){
      if (String(vv).trim() === "") state.items[i][k] = "";
      else state.items[i][k] = toNumber(vv);
    } else {
      state.items[i][k] = vv;
    }
    recalc();
  });

  tbody.addEventListener("change", (e) => {
    const el = e.target;
    if (!el.dataset || el.dataset.i === undefined) return;
    const i = parseInt(el.dataset.i, 10);
    const k = el.dataset.k;
    if (!state.items[i]) return;

    if (k === "vatEnabled"){
      state.items[i].vatEnabled = !!el.checked;
      recalc();
    }
  });

  tbody.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-del]");
    if (!btn) return;
    const idx = parseInt(btn.dataset.del, 10);
    state.items.splice(idx, 1);
    renderItems();
  });

  document.getElementById("addRowBtn").addEventListener("click", () => {
    state.items.push({ date:"", desc:"", qty:"", unit:"", debit:"", credit:"", vatRate: 3.8, vatEnabled: true });
    renderItems();
  });

  // -----------------------------
  // Recalc totals + VAT breakdown
  // -----------------------------
  function recalc(){
    state.items = state.items.map(it => {
      const qty = toNumber(it.qty);
      const unit = toNumber(it.unit);
      const debit = it.debit === "" ? "" : toNumber(it.debit);
      const credit = it.credit === "" ? "" : toNumber(it.credit);

      if ((debit === "" || debit === 0) && (credit === "" || credit === 0) && qty > 0 && unit > 0){
        return { ...it, debit: round2(qty*unit) };
      }
      return it;
    });

    let totalDebit = 0;
    let totalCredit = 0;
    for (const it of state.items){
      totalDebit += (it.debit === "" ? 0 : toNumber(it.debit));
      totalCredit += (it.credit === "" ? 0 : toNumber(it.credit));
    }
    const balance = totalDebit - totalCredit;

    document.getElementById("totalDebit").textContent = fmt(totalDebit);
    document.getElementById("totalCredit").textContent = fmt(totalCredit);
    document.getElementById("balance").textContent = fmt(balance);
    document.getElementById("grandTotal").textContent = fmt(balance);

    const groups = new Map();
    for (const it of state.items){
      if (!it.vatEnabled) continue;
      const rate = toNumber(it.vatRate);
      if (rate <= 0) continue;

      const lineAmount = (it.debit === "" ? 0 : toNumber(it.debit)) - (it.credit === "" ? 0 : toNumber(it.credit));
      if (lineAmount === 0) continue;

      const prev = groups.get(rate) || { gross: 0 };
      prev.gross += lineAmount;
      groups.set(rate, prev);
    }

    const vatBody = document.querySelector("#vatBreakdownTable tbody");
    vatBody.innerHTML = "";

    const pVat = document.getElementById("p_vatRows");
    pVat.innerHTML = "";

    const rates = Array.from(groups.keys()).sort((a,b) => a-b);

    if (rates.length === 0){
      vatBody.innerHTML = `<tr><td class="muted" colspan="4">Keine MwSt-pflichtigen Positionen.</td></tr>`;
      pVat.innerHTML = `<tr><td class="muted" colspan="4" style="padding:6px 4px;">Keine MwSt.</td></tr>`;
    } else {
      for (const rate of rates){
        const gross = groups.get(rate).gross;
        const r = rate / 100;
        const net = gross / (1 + r);
        const vat = gross - net;

        vatBody.insertAdjacentHTML("beforeend", `
          <tr>
            <td class="mono">${rate.toFixed(1)}%</td>
            <td class="num mono">${fmt(net)}</td>
            <td class="num mono">${fmt(vat)}</td>
            <td class="num mono">${fmt(gross)}</td>
          </tr>
        `);

        pVat.insertAdjacentHTML("beforeend", `
          <tr>
            <td class="mono" style="padding:6px 4px;border-bottom:1px solid #eee;">${rate.toFixed(1)}%</td>
            <td class="num mono" style="padding:6px 4px;border-bottom:1px solid #eee;">${fmt(net)}</td>
            <td class="num mono" style="padding:6px 4px;border-bottom:1px solid #eee;">${fmt(vat)}</td>
            <td class="num mono" style="padding:6px 4px;border-bottom:1px solid #eee;">${fmt(gross)}</td>
          </tr>
        `);
      }
    }

    syncPrintable(totalDebit, totalCredit, balance);
  }

  // -----------------------------
  // Sync printable invoice
  // -----------------------------
  function syncPrintable(totalDebit, totalCredit, balance){
    setText("p_invoiceNo", v("invoiceNo") || "—");
    setText("p_invoiceDate", v("invoiceDate") || "—");
    setText("p_arrival", v("arrival") || "—");
    setText("p_departure", v("departure") || "—");
    setText("p_roomRes", v("roomReservation") || "—");
    setText("p_currency", v("currency") || "—");

    const sellerHeadMain = [ v("sellerName"), v("sellerAddressBlock") ].filter(Boolean).join("\n");
    setText("p_sellerHeadMain", sellerHeadMain);

    const sellerHeadContact = [ v("sellerContact"), v("sellerExtra") ].filter(Boolean).join(" | ");
    setText("p_sellerHeadContact", sellerHeadContact);

    const sellerBlock = [ v("sellerName"), v("sellerAddressBlock"), v("sellerContact"), v("sellerExtra") ].filter(Boolean).join("\n");
    setText("p_seller", sellerBlock);

    const buyerBlock = [ v("buyerName"), v("buyerAddressBlock") ].filter(Boolean).join("\n");
    setText("p_buyer", buyerBlock);

    setText("p_reference", v("reference") || "—");

    const pItems = document.getElementById("p_items");
    pItems.innerHTML = "";
    for (const it of state.items){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${escapeHtml(it.date ?? "")}</td>
        <td>${escapeHtml(it.desc ?? "")}</td>
        <td class="num mono">${(it.qty === "" ? "" : toNumber(it.qty).toString())}</td>
        <td class="num mono">${(it.unit === "" ? "" : toNumber(it.unit).toFixed(2))}</td>
        <td class="num mono">${(it.debit === "" ? "" : fmt(toNumber(it.debit)))}</td>
        <td class="num mono">${(it.credit === "" ? "" : fmt(toNumber(it.credit)))}</td>
        <td class="num mono">${it.vatEnabled ? (toNumber(it.vatRate).toFixed(1) + "%") : "—"}</td>
      `;
      pItems.appendChild(tr);
    }

    setText("p_totalDebit", fmt(totalDebit));
    setText("p_totalCredit", fmt(totalCredit));
    setText("p_balance", fmt(balance));
    setText("p_legalFooter", v("legalFooter") || "");
  }

  const headerInputs = [
    "sellerName","sellerContact","sellerExtra","sellerAddressBlock",
    "buyerName","buyerAddressBlock","reference",
    "invoiceNo","invoiceDate","currency",
    "arrival","departure","roomReservation",
    "legalFooter"
  ];
  headerInputs.forEach(id => {
    document.getElementById(id).addEventListener("input", recalc);
  });

  // -----------------------------
  // Print
  // -----------------------------
  document.getElementById("printBtn").addEventListener("click", () => {
    recalc();
    window.print();
  });

  // -----------------------------
  // Finale PDF exportieren
  // -----------------------------
  document.getElementById("exportPdfBtn").addEventListener("click", async () => {
    try{
      recalc();

      const ok = await ensureExportLibs();
      if (!ok){
        alert("Export-Libraries sind blockiert. Bitte nutze „Drucken / Als PDF speichern“.");
        return;
      }

      const paper = document.getElementById("invoicePaper");

      let canvas;
      try{
        canvas = await html2canvas(paper, {
          scale: 2,
          useCORS: true,
          backgroundColor: "#ffffff"
        });
        canvas.toDataURL("image/png");
      } catch (e1){
        console.warn("Export attempt 1 failed (tainted?). Retrying without logo…", e1);

        canvas = await html2canvas(paper, {
          scale: 2,
          useCORS: false,
          backgroundColor: "#ffffff",
          onclone: (doc) => {
            doc.querySelectorAll("#invoicePaper img").forEach(img => img.remove());
            const fb = doc.getElementById("logoFallback");
            if (fb){
              fb.style.display = "block";
              fb.style.color = "#666";
              fb.innerHTML = 'ibis<br><span style="font-size:11px;color:#666;">Zurich Messe Airport</span>';
            }
          }
        });

        canvas.toDataURL("image/png");
      }

      const imgData = canvas.toDataURL("image/png");

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("p", "mm", "a4");

      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();

      const imgProps = pdf.getImageProperties(imgData);
      const imgWidth = pageWidth;
      const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

      if (imgHeight <= pageHeight){
        pdf.addImage(imgData, "PNG", 0, 0, imgWidth, imgHeight);
      } else {
        let remaining = imgHeight;
        let position = 0;
        while (remaining > 0){
          pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
          remaining -= pageHeight;
          position -= pageHeight;
          if (remaining > 0) pdf.addPage();
        }
      }

      const inv = (v("invoiceNo") || "invoice").replace(/[^\w\-]+/g,"_");
      pdf.save(`Finale_Rechnung_${inv}.pdf`);
      setPill("exportPill", "<b>Export:</b> PDF erstellt ✓", "ok");

    } catch (err){
      console.error(err);
      const msg = String(err?.message || err);
      setPill("exportPill", "<b>Export:</b> Fehler", "warn");

      if (msg.toLowerCase().includes("tainted")){
        alert(
          "PDF Export blockiert (tainted canvas).\n\n" +
          "Workaround: Nutze „Drucken / Als PDF speichern“."
        );
      } else {
        alert("PDF Export fehlgeschlagen: " + msg);
      }
    }
  });

  // -----------------------------
  // JSON Import/Export
  // -----------------------------
  document.getElementById("exportJsonBtn").addEventListener("click", () => {
    const data = collectFormData();
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `invoice_editor_${(data.invoiceNo || "export")}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  });

  document.getElementById("importJson").addEventListener("change", async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    const text = await file.text();
    const data = JSON.parse(text);
    applyFormData(data);
    e.target.value = "";
  });

  function collectFormData(){
    return {
      sellerName: v("sellerName"),
      sellerContact: v("sellerContact"),
      sellerExtra: v("sellerExtra"),
      sellerAddressBlock: v("sellerAddressBlock"),

      buyerName: v("buyerName"),
      buyerAddressBlock: v("buyerAddressBlock"),

      reference: v("reference"),
      invoiceNo: v("invoiceNo"),
      invoiceDate: v("invoiceDate"),
      currency: v("currency"),
      arrival: v("arrival"),
      departure: v("departure"),
      roomReservation: v("roomReservation"),

      legalFooter: v("legalFooter"),
      items: state.items
    };
  }

  function applyFormData(d){
    if (!d) return;

    setV("sellerName", d.sellerName ?? v("sellerName") ?? "");
    setV("sellerContact", d.sellerContact ?? v("sellerContact") ?? "");
    setV("sellerExtra", d.sellerExtra ?? v("sellerExtra") ?? "");
    setV("sellerAddressBlock", d.sellerAddressBlock ?? v("sellerAddressBlock") ?? "");

    setV("buyerName", d.buyerName ?? v("buyerName") ?? "");
    setV("buyerAddressBlock", d.buyerAddressBlock ?? v("buyerAddressBlock") ?? "");

    setV("reference", d.reference ?? v("reference") ?? "");
    setV("invoiceNo", d.invoiceNo ?? v("invoiceNo") ?? "");
    setV("invoiceDate", d.invoiceDate ?? v("invoiceDate") ?? "");
    setV("currency", d.currency ?? v("currency") ?? "CHF");
    setV("arrival", d.arrival ?? v("arrival") ?? "");
    setV("departure", d.departure ?? v("departure") ?? "");
    setV("roomReservation", d.roomReservation ?? v("roomReservation") ?? "");

    setV("legalFooter", d.legalFooter ?? v("legalFooter") ?? "");

    state.items = Array.isArray(d.items) ? d.items : state.items;
    renderItems();
  }

  // -----------------------------
  // PDF Import
  // -----------------------------
  const pdfFileInput = document.getElementById("pdfFile");
  const extractedTextEl = document.getElementById("extractedText");

  pdfFileInput.addEventListener("change", async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    setPill("importPill", `<b>Import:</b> ${escapeHtml(file.name)} …`, "");

    const ok = await ensurePdfJsReady();
    if (!ok){
      setPill("importPill", `<b>Import:</b> blockiert (Text-Fallback)`, "warn");
      alert(
        "PDF.js ist blockiert.\n\nBitte nutze „Import per Text (Fallback)“:\n" +
        "- PDF öffnen\n- Text markieren & kopieren\n- im Dialog einfügen"
      );
      e.target.value = "";
      return;
    }

    try{
      const buf = await file.arrayBuffer();
      const data = new Uint8Array(buf);

      let pdf;
      try{
        pdf = await pdfjsLib.getDocument({ data }).promise;
      } catch (err1){
        console.warn("Worker blocked? retry disableWorker", err1);
        pdf = await pdfjsLib.getDocument({ data, disableWorker: true }).promise;
        setPill("workerPill", "<b>PDF.js:</b> Worker deaktiviert (Fallback)", "warn");
      }

      const allRows = [];
      let fullText = "";

      for (let p=1; p<=pdf.numPages; p++){
        const page = await pdf.getPage(p);
        const rows = await pageToRows(page);
        allRows.push(...rows);

        // Debug text
        for (const r of rows){
          const line = rowToText(r.parts);
          if (line) fullText += line + "\n";
        }
        fullText += "\n";
      }

      fullText = normalizeText(fullText);
      extractedTextEl.value = fullText;

      // Default VAT rate: from "VAT Breakdown" line if present
      const mVat = fullText.match(/\bVAT\s*([0-9]+(?:[.,][0-9]+)?)\s*%/i);
      const defaultVatRate = mVat ? toNumber(mVat[1]) : 3.8;

      // 1) Parse table strictly by columns (fixes your wrong 511 / 0.15 / 78.5 issue)
      const items = parseIbisTableFromRows(allRows, defaultVatRate);

      // 2) Extract header blocks (seller/buyer)
      const blocks = extractHeaderBlocks(allRows);

      // 3) Parse meta from text (invoice no/date/arrival/departure)
      const meta = parseMetaFromText(fullText);

      const parsed = {
        ...collectFormData(),
        ...blocks,
        ...meta,
        items: items.length ? items : collectFormData().items
      };

      applyFormData(parsed);

      if (items.length){
        setPill("importPill", `<b>Import:</b> ${escapeHtml(file.name)} ✓`, "ok");
      } else {
        setPill("importPill", `<b>Import:</b> Tabelle nicht erkannt (Debug prüfen)`, "warn");
        alert("PDF importiert, aber Tabelle wurde nicht sicher erkannt. Bitte im Debug-Feld prüfen.");
      }

    } catch(err){
      console.error(err);
      setPill("importPill", `<b>Import:</b> Fehler`, "warn");
      alert("PDF Import fehlgeschlagen: " + (err?.message || err));
    } finally {
      e.target.value = "";
    }
  });

  // -----------------------------
  // Meta parser from text (invoice no/date/arrival/departure/room/reservation/currency)
  // -----------------------------
  function parseMetaFromText(t){
    const out = {};
    const pick = (re) => {
      const m = t.match(re);
      return m ? (m[1] ?? "").trim() : "";
    };

    const invNo =
      pick(/\bInvoice\s*(?:No\.?|Number|N°|Nr\.?)\s*[:\-]?\s*([A-Z0-9\-\/]{3,})/i) ||
      pick(/\bINVOICE\s*(?:No\.?|NUMBER|N°|NR\.?)\s*[:\-]?\s*([A-Z0-9\-\/]{3,})/i);

    const invDate =
      pick(/\b(?:Invoice\s*)?Date\s*[:\-]?\s*([0-9]{2}[.\/][0-9]{2}[.\/][0-9]{2,4})/i);

    const arrival =
      pick(/\bArrival\s*[:\-]?\s*([0-9]{2}[.\/][0-9]{2}[.\/][0-9]{2,4})/i);

    const departure =
      pick(/\bDeparture\s*[:\-]?\s*([0-9]{2}[.\/][0-9]{2}[.\/][0-9]{2,4})/i);

    const currency = pick(/\bCurrency\s*[:\-]?\s*([A-Z]{3})\b/i);

    if (invNo) out.invoiceNo = invNo;
    if (invDate) out.invoiceDate = invDate.replace(/\//g,".");
    if (arrival) out.arrival = arrival.replace(/\//g,".");
    if (departure) out.departure = departure.replace(/\//g,".");
    if (currency) out.currency = currency;

    // Room / Reservation lines often appear with numbers; try to pick them
    const room = pick(/\bRoom\s*No\.?\s*[:\-]?\s*([0-9A-Z\-]+)/i);
    const res = pick(/\bReservation\s*No\.?\s*[:\-]?\s*([0-9A-Z\-]+)/i);
    if (room || res){
      out.roomReservation = [room ? `Room ${room}` : "", res ? `Reservation ${res}` : ""].filter(Boolean).join(" | ");
    }
    return out;
  }

  // -----------------------------
  // Text-Fallback Import (copy/paste)
  // -----------------------------
  document.getElementById("manualImportBtn").addEventListener("click", () => {
    const existing = extractedTextEl.value?.trim() ? extractedTextEl.value.trim() : "";
    const txt = prompt(
      "Fallback-Import (Copy/Paste):\n\n" +
      "1) PDF öffnen\n" +
      "2) Text markieren & kopieren\n" +
      "3) Hier einfügen und OK\n\n" +
      "Hinweis: Wenn PDF nur ein Scan/Bild ist, ist kaum Text kopierbar.",
      existing
    );
    if (!txt) return;

    extractedTextEl.value = txt;

    // Fallback cannot do perfect X-column parsing, so we only parse meta + some lines
    const meta = parseMetaFromText(normalizeText(txt));
    applyFormData({ ...collectFormData(), ...meta });
    setPill("importPill", "<b>Import:</b> Text-Fallback ✓ (ohne perfekte Tabelle)", "warn");
  });

  // -----------------------------
  // Init
  // -----------------------------
  (function init(){
    setPill("workerPill", "<b>PDF.js:</b> bereit (wird bei Bedarf geladen)", "");
    setPill("importPill", "<b>Import:</b> bereit", "");
    setPill("exportPill", "<b>Export:</b> bereit (wird bei Bedarf geladen)", "");
    renderItems();
    recalc();
  })();
</script>
</body>
</html>
