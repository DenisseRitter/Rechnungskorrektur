<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Rechnungskorrektur – MwSt pro Position + PDF Import + PDF Export + Fixes Logo</title>

  <!-- PDF.js (Import) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.min.js"></script>

  <!-- PDF Export (client-side) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root{
      --ink:#111;
      --muted:#666;
      --line:#d9d9d9;
      --bg:#fafafa;
      --card:#fff;
      --accent:#1d4ed8;
      --ok:#0f766e;
      --warn:#b45309;
    }
    *{ box-sizing:border-box; }
    body{ margin:0; font: 13px/1.35 system-ui,-apple-system,Segoe UI,Roboto,Arial; color:var(--ink); background:var(--bg); }

    header{
      background:var(--card);
      border-bottom:1px solid var(--line);
      padding:14px 18px;
      display:flex; gap:12px; align-items:center; flex-wrap:wrap;
    }
    header h1{ font-size:14px; margin:0; font-weight:800; letter-spacing:.2px; }
    .toolbar{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-left:auto; }
    .btn{
      border:1px solid var(--line);
      background:var(--card);
      padding:8px 10px;
      border-radius:10px;
      cursor:pointer;
      font-weight:700;
      white-space:nowrap;
      user-select:none;
    }
    .btn.primary{ background:var(--accent); color:#fff; border-color:transparent; }
    .btn.success{ background:var(--ok); color:#fff; border-color:transparent; }
    .btn:active{ transform: translateY(1px); }

    /* WICHTIG: nicht display:none (sonst blocken manche Browser <label for=...>) */
    input[type="file"]{
      position:absolute;
      left:-9999px;
      width:1px; height:1px;
      opacity:0;
    }

    main{
      padding:14px;
      max-width: 1100px;
      margin:0 auto;
    }

    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:14px;
      box-shadow: 0 1px 0 rgba(0,0,0,.03);
      overflow:hidden;
    }
    .card .hd{
      padding:12px 14px;
      border-bottom:1px solid var(--line);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .card .hd strong{ font-size:13px; }
    .card .bd{ padding:14px; }

    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    .grid3{ display:grid; grid-template-columns:1fr 1fr 1fr; gap:10px; }
    @media (max-width: 700px){ .grid2,.grid3{ grid-template-columns:1fr; } }

    label{ display:block; font-size:11px; color:var(--muted); margin-bottom:6px; }
    .field{
      border:1px solid var(--line);
      border-radius:10px;
      padding:9px 10px;
      width:100%;
      background:#fff;
      outline:none;
      font: inherit;
    }
    textarea.field{ min-height: 86px; resize: vertical; }
    .field:focus{ border-color:#c7d2fe; box-shadow:0 0 0 3px rgba(99,102,241,.15); }

    table{ width:100%; border-collapse:collapse; font-size:12px; }
    thead th{
      text-align:left; font-size:11px; color:var(--muted);
      padding:8px 8px; border-bottom:1px solid var(--line);
      background:#fff; position:sticky; top:0; z-index:1;
    }
    tbody td{ padding:6px 6px; border-bottom:1px solid #eee; vertical-align:top; }
    tbody tr:hover{ background:#fcfcff; }
    .num{ text-align:right; }
    .right{ text-align:right; }
    .muted{ color:var(--muted); }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    .rowinput{
      width:100%;
      border:1px solid #eee;
      border-radius:8px;
      padding:6px 8px;
      outline:none;
      background:#fff;
      font: inherit;
    }
    .rowinput:focus{ border-color:#c7d2fe; box-shadow:0 0 0 3px rgba(99,102,241,.15); }
    .toggle{
      display:flex; align-items:center; justify-content:center;
      gap:6px;
    }
    .toggle input{ transform: scale(1.05); }

    .hint{ font-size:11px; color:var(--muted); }

    .totals{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .totals .box{
      border:1px solid var(--line);
      border-radius:12px;
      padding:10px;
      background:#fff;
    }
    .totals .box .k{ font-size:11px; color:var(--muted); }
    .totals .box .v{ font-size:16px; font-weight:900; margin-top:4px; }

    .statusBar{
      border:1px solid #f0f0f0;
      border-radius:12px;
      padding:10px;
      background:#fff;
      display:flex;
      flex-wrap:wrap;
      gap:10px 14px;
      align-items:center;
      margin-top:12px;
    }
    .statusPill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border:1px solid #eee;
      border-radius:999px;
      font-size:12px;
      background:#fff;
      color:var(--muted);
    }
    .statusPill.ok{ color:var(--ok); border-color:#d1fae5; }
    .statusPill.warn{ color:var(--warn); border-color:#ffedd5; }
    .statusPill b{ color:inherit; }

    /* ---------- Printable invoice area ---------- */
    .invoicePaper{
      background:#fff;
      border:1px solid var(--line);
      border-radius:14px;
      padding:16px;
    }

    .invoiceHeader{
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:16px;
      align-items:start;
      border-bottom:1px solid #eee;
      padding-bottom:12px;
      margin-bottom:12px;
    }
    @media (max-width: 900px){
      .invoiceHeader{ grid-template-columns: 1fr; }
    }

    .brandRow{
      display:grid;
      grid-template-columns: 180px 1fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 700px){
      .brandRow{ grid-template-columns: 1fr; }
    }

    .logoBox{
      width:180px;
      height:80px;
      border:1px solid #eee;
      border-radius:12px;
      display:flex;
      align-items:center;
      justify-content:center;
      overflow:hidden;
      background:#fff;
    }
    .logoBox img{ max-width:100%; max-height:100%; object-fit:contain; display:block; }
    .sellerHead{
      border:1px solid #f0f0f0;
      border-radius:12px;
      padding:10px;
      background:#fff;
      white-space:pre-wrap;
      font-weight:700;
    }
    .sellerHead .small{ font-weight:600; color:var(--muted); margin-top:6px; }

    .meta{
      display:grid;
      grid-template-columns: 1fr;
      gap:8px;
    }
    .meta .kv{
      display:flex;
      justify-content:space-between;
      gap:10px;
      border:1px solid #f0f0f0;
      border-radius:10px;
      padding:8px 10px;
      background:#fff;
    }
    .meta .kv b{ font-weight:800; }
    .meta .kv span{ color:var(--muted); }

    .blocks{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-bottom:10px;
    }
    @media (max-width: 700px){
      .blocks{ grid-template-columns: 1fr; }
    }

    .block{
      border:1px solid #eee;
      border-radius:12px;
      padding:10px;
      background:#fff;
      min-height:90px;
    }
    .block .t{ font-size:11px; color:var(--muted); margin-bottom:6px; }
    .block .v{ font-weight:700; white-space:pre-wrap; }

    .paperTable th, .paperTable td{ padding:6px 6px; border-bottom:1px solid #eee; }
    .paperTable thead th{ position:static; top:auto; }

    .paperFooter{
      margin-top:12px;
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 900px){
      .paperFooter{ grid-template-columns: 1fr; }
    }

    .paperTotals{
      border:1px solid #eee;
      border-radius:12px;
      padding:10px;
    }
    .paperTotals .line{
      display:flex; justify-content:space-between; gap:10px; padding:4px 0;
    }
    .paperTotals .line b{ font-weight:900; }

    .paperVat{
      border:1px solid #eee;
      border-radius:12px;
      padding:10px;
    }

    .paperLegal{
      margin-top:12px;
      border-top:1px solid #eee;
      padding-top:10px;
      font-size:11px;
      color:var(--muted);
      line-height:1.35;
      white-space:pre-wrap;
    }

    details summary{
      cursor:pointer;
      font-weight:800;
    }

    /* ---------- Print CSS ---------- */
    @media print{
      body{ background:#fff; }
      header, .noPrint{ display:none !important; }
      main{ display:block; padding:0; margin:0; max-width:none; }
      .card{ border:none; box-shadow:none; }
      .invoicePaper{ border:none; border-radius:0; padding:0; }
      @page{ size:A4; margin:12mm; }
    }
  </style>
</head>

<body>
<header>
  <h1>Rechnungskorrektur: MwSt pro Position • PDF Import • Fixes ibis-Logo • Druck/PDF Export</h1>

  <div class="toolbar">
    <label class="btn primary" for="pdfFile">PDF importieren</label>
    <input id="pdfFile" type="file" accept="application/pdf" />

    <button class="btn" id="addRowBtn" type="button">+ Position</button>

    <button class="btn" id="printBtn" type="button">Drucken / Als PDF speichern</button>
    <button class="btn success" id="exportPdfBtn" type="button">Finale PDF exportieren</button>

    <button class="btn" id="exportJsonBtn" type="button">Export JSON</button>
    <label class="btn" for="importJson">JSON import</label>
    <input id="importJson" type="file" accept="application/json" />
  </div>
</header>

<main>
  <section class="card">
    <div class="hd">
      <strong>Editor (alles anpassbar)</strong>
      <span class="hint">Jede Position kann eigenen MwSt-Satz haben (oder „nicht steuerbar“).</span>
    </div>

    <div class="bd">
      <div class="grid3">
        <div>
          <label>Hotel / Firma</label>
          <input id="sellerName" class="field" value="ibis Zurich Messe Airport" />
        </div>
        <div>
          <label>Kontakt / Web (Kopfzeile)</label>
          <input id="sellerContact" class="field" value="+41 44 307 47 00 | H2980@accor.com | www.all.accor.com" />
        </div>
        <div>
          <label>Optionale Zusatzzeile</label>
          <input id="sellerExtra" class="field" value="" />
        </div>
      </div>

      <div style="height:10px;"></div>

      <div>
        <label>Adresse Verkäufer (ein Feld)</label>
        <textarea id="sellerAddressBlock" class="field">Heidi Abel-Weg 5
CH-8050 ZURICH
Switzerland</textarea>
      </div>

      <div style="height:14px;"></div>

      <div class="grid2">
        <div>
          <label>Kunde</label>
          <input id="buyerName" class="field" value="BEY TOURS" />
        </div>
        <div>
          <label>Referenz / Gastname</label>
          <input id="reference" class="field" value="Beytours 12019-1338" />
        </div>
      </div>

      <div style="height:10px;"></div>

      <div>
        <label>Adresse Kunde (ein Feld)</label>
        <textarea id="buyerAddressBlock" class="field">DMC - Incoming France
35 rue d'Hauteville
75010 Paris
France</textarea>
      </div>

      <div style="height:14px;"></div>

      <div class="grid3">
        <div>
          <label>Invoice No.</label>
          <input id="invoiceNo" class="field" value="39498" />
        </div>
        <div>
          <label>Rechnungsdatum</label>
          <input id="invoiceDate" class="field" value="05.01.2026" />
        </div>
        <div>
          <label>Währung</label>
          <input id="currency" class="field" value="CHF" />
        </div>
      </div>

      <div style="height:10px;"></div>

      <div class="grid3">
        <div>
          <label>Anreise</label>
          <input id="arrival" class="field" value="02.01.2026" />
        </div>
        <div>
          <label>Abreise</label>
          <input id="departure" class="field" value="05.01.2026" />
        </div>
        <div>
          <label>Zimmer / Reservation</label>
          <input id="roomReservation" class="field" value="Room 9295 | Reservation 594489457" />
        </div>
      </div>

      <div class="statusBar">
        <span class="statusPill" id="importPill"><b>Import:</b> —</span>
        <span class="statusPill" id="workerPill"><b>PDF.js:</b> —</span>
        <span class="hint" id="importHint">Wenn nach Import keine Daten übernommen werden: unten “Import-Text” prüfen (PDF evtl. nur Bild).</span>
      </div>

      <div style="height:14px;"></div>

      <div class="card" style="border-radius:12px;">
        <div class="hd">
          <strong>Positionen</strong>
          <span class="hint">QTY × Unit → Debit (wenn Debit leer). MwSt je Zeile wählbar.</span>
        </div>
        <div class="bd" style="padding:0;">
          <div style="max-height:340px; overflow:auto;">
            <table id="itemsTable">
              <thead>
                <tr>
                  <th style="width:110px;">Datum</th>
                  <th>Beschreibung</th>
                  <th class="num" style="width:70px;">QTY</th>
                  <th class="num" style="width:90px;">Unit</th>
                  <th class="num" style="width:110px;">Debit</th>
                  <th class="num" style="width:110px;">Credit</th>
                  <th class="num" style="width:92px;">MwSt %</th>
                  <th style="width:86px;">MwSt?</th>
                  <th style="width:70px;"></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div style="height:14px;"></div>

      <div class="totals">
        <div class="box">
          <div class="k">Total Debit</div>
          <div class="v mono" id="totalDebit">0.00</div>
        </div>
        <div class="box">
          <div class="k">Total Credit</div>
          <div class="v mono" id="totalCredit">0.00</div>
        </div>
        <div class="box">
          <div class="k">Saldo (Debit − Credit)</div>
          <div class="v mono" id="balance">0.00</div>
        </div>
        <div class="box">
          <div class="k">Endbetrag / Total</div>
          <div class="v mono" id="grandTotal">0.00</div>
        </div>
      </div>

      <div style="height:14px;"></div>

      <div class="card" style="border-radius:12px;">
        <div class="hd">
          <strong>MwSt-Aufschlüsselung (pro Satz)</strong>
          <span class="hint">Steuerbasis je Satz = Summe steuerbarer Zeilen (Debit − Credit).</span>
        </div>
        <div class="bd">
          <table id="vatBreakdownTable">
            <thead>
              <tr>
                <th>MwSt %</th>
                <th class="num">Netto</th>
                <th class="num">MwSt</th>
                <th class="num">Brutto</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="hint" style="margin-top:8px;">
            Logik: Zeile hat „MwSt?“ an/aus + MwSt-%. Credits reduzieren die Basis.
          </div>
        </div>
      </div>

      <div style="height:18px;"></div>

      <!-- Printable invoice -->
      <div class="invoicePaper" id="invoicePaper">
        <div class="invoiceHeader">
          <div>
            <div class="brandRow">
              <div class="logoBox" title="Logo (fix)">
                <img id="logoImg" src="Logo_ibis_RGB.png" alt="Logo ibis"
                     onerror="this.style.display='none';document.getElementById('logoFallback').style.display='block';" />
                <div id="logoFallback" class="muted" style="display:none;text-align:center;padding:8px;">
                  Logo fehlt<br><span class="hint">Datei: <span class="mono">Logo_ibis_RGB.png</span></span>
                </div>
              </div>

              <div class="sellerHead">
                <div id="p_sellerHeadMain"></div>
                <div class="small" id="p_sellerHeadContact"></div>
              </div>
            </div>
          </div>

          <div>
            <div style="font-weight:900;font-size:16px;margin-bottom:6px;">INVOICE</div>
            <div class="meta">
              <div class="kv"><span>Invoice No.</span><b id="p_invoiceNo">—</b></div>
              <div class="kv"><span>Date</span><b id="p_invoiceDate">—</b></div>
              <div class="kv"><span>Arrival</span><b id="p_arrival">—</b></div>
              <div class="kv"><span>Departure</span><b id="p_departure">—</b></div>
              <div class="kv"><span>Room / Reservation</span><b id="p_roomRes">—</b></div>
              <div class="kv"><span>Currency</span><b id="p_currency">—</b></div>
            </div>
          </div>
        </div>

        <div class="blocks">
          <div class="block">
            <div class="t">From</div>
            <div class="v" id="p_seller"></div>
          </div>
          <div class="block">
            <div class="t">To</div>
            <div class="v" id="p_buyer"></div>
          </div>
        </div>

        <div class="block" style="margin-bottom:12px;">
          <div class="t">Reference</div>
          <div class="v" id="p_reference"></div>
        </div>

        <table class="paperTable">
          <thead>
            <tr>
              <th style="width:90px;">Date</th>
              <th>Description</th>
              <th class="num" style="width:60px;">QTY</th>
              <th class="num" style="width:90px;">Unit</th>
              <th class="num" style="width:100px;">Debit</th>
              <th class="num" style="width:100px;">Credit</th>
              <th class="num" style="width:70px;">VAT%</th>
            </tr>
          </thead>
          <tbody id="p_items"></tbody>
        </table>

        <div class="paperFooter">
          <div class="paperVat">
            <div style="font-weight:900;margin-bottom:6px;">VAT Breakdown</div>
            <table style="width:100%; border-collapse:collapse; font-size:12px;">
              <thead>
                <tr>
                  <th style="text-align:left;color:var(--muted);font-size:11px;border-bottom:1px solid #eee;padding:6px 4px;">VAT%</th>
                  <th class="num" style="color:var(--muted);font-size:11px;border-bottom:1px solid #eee;padding:6px 4px;">Net</th>
                  <th class="num" style="color:var(--muted);font-size:11px;border-bottom:1px solid #eee;padding:6px 4px;">VAT</th>
                  <th class="num" style="color:var(--muted);font-size:11px;border-bottom:1px solid #eee;padding:6px 4px;">Gross</th>
                </tr>
              </thead>
              <tbody id="p_vatRows"></tbody>
            </table>
          </div>

          <div class="paperTotals">
            <div style="font-weight:900;margin-bottom:6px;">Totals</div>
            <div class="line"><span>Total Debit</span><b class="mono" id="p_totalDebit">—</b></div>
            <div class="line"><span>Total Credit</span><b class="mono" id="p_totalCredit">—</b></div>
            <div class="line" style="border-top:1px solid #eee;margin-top:6px;padding-top:8px;">
              <span>Balance</span><b class="mono" id="p_balance">—</b>
            </div>
          </div>
        </div>

        <div class="paperLegal" id="p_legalFooter"></div>
      </div>

      <div class="noPrint" style="margin-top:10px;">
        <div class="hint">Für PDF: entweder „Drucken / Als PDF speichern“ oder „Finale PDF exportieren“ (Download).</div>
      </div>

      <div style="height:14px;"></div>

      <div class="card" style="border-radius:12px;">
        <div class="hd">
          <strong>Fußzeile / Bankdaten / Rechtstext (wird gedruckt)</strong>
          <span class="hint">Hier „Bankdaten“ + „Essendi Switzerland …“ eintragen.</span>
        </div>
        <div class="bd">
          <label>Footer-Text</label>
          <textarea id="legalFooter" class="field">Essendi Switzerland SA (ehem. AccorInvest)
[Bank / IBAN / BIC / Konto / Zahlungsziel etc. hier einfügen]
Weitere Informationen / rechtliche Angaben …</textarea>
        </div>
      </div>

      <div style="height:14px;"></div>

      <!-- Debug: extracted text (no second page, but visible on demand) -->
      <details class="card" style="border-radius:12px;">
        <summary class="hd"><strong>Import-Text (Debug) anzeigen</strong><span class="hint">Hier siehst du den aus dem PDF gelesenen Text.</span></summary>
        <div class="bd">
          <label>Ausgelesener Text (PDF.js)</label>
          <textarea id="extractedText" class="field mono" style="min-height:240px;" placeholder="Nach PDF-Import erscheint hier der Text …"></textarea>
          <div class="hint" style="margin-top:8px;">
            Wenn hier fast nichts steht: PDF ist vermutlich gescannt (Bild) → ohne OCR kann man keine Daten zuverlässig importieren.
          </div>
        </div>
      </details>

    </div>
  </section>
</main>

<script>
  // -----------------------------
  // State
  // -----------------------------
  const state = {
    items: [
      { date: "02.01.26", desc: "Accommodation", qty: 2, unit: 135.00, debit: "", credit: "", vatRate: 3.8, vatEnabled: true },
      { date: "02.01.26", desc: "City Tax", qty: 46, unit: 3.50, debit: "", credit: "", vatRate: 0.0, vatEnabled: false },
      { date: "02.01.26", desc: "Deposit Transfered", qty: 1, unit: 2467.00, debit: "", credit: 2467.00, vatRate: 0.0, vatEnabled: false },
    ]
  };

  // -----------------------------
  // Helpers
  // -----------------------------
  function toNumber(val){
    if (val === null || val === undefined) return 0;
    if (typeof val === "number") return isFinite(val) ? val : 0;

    // robust: "1 234.50", "1'234.50", "1.234,50", "1234,50"
    let s = String(val).trim();
    if (!s) return 0;
    s = s.replace(/\s/g,"").replace(/’/g,"").replace(/'/g,"");

    // if has both "." and "," assume last separator is decimal
    const hasDot = s.includes(".");
    const hasComma = s.includes(",");
    if (hasDot && hasComma){
      const lastDot = s.lastIndexOf(".");
      const lastComma = s.lastIndexOf(",");
      const decIsComma = lastComma > lastDot;
      if (decIsComma){
        s = s.replace(/\./g,"").replace(",",".");
      } else {
        s = s.replace(/,/g,"");
      }
    } else if (hasComma && !hasDot){
      s = s.replace(",",".");
    } else {
      s = s.replace(/,/g,"");
    }

    const n = parseFloat(s);
    return isFinite(n) ? n : 0;
  }
  function round2(n){ return Math.round(n*100)/100; }

  function fmt(n){
    const cur = document.getElementById("currency").value || "CHF";
    return `${round2(n).toFixed(2)} ${cur}`;
  }
  function escapeHtml(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }
  function setPill(id, text, kind){
    const el = document.getElementById(id);
    if (!el) return;
    el.classList.remove("ok","warn");
    if (kind) el.classList.add(kind);
    el.innerHTML = text;
  }

  function normalizeText(t){
    return (t || "")
      .replace(/\r/g,"")
      .replace(/[ \t]+\n/g,"\n")
      .replace(/\n{3,}/g,"\n\n")
      .trim();
  }

  // -----------------------------
  // Items table render
  // -----------------------------
  const tbody = document.querySelector("#itemsTable tbody");

  function renderItems(){
    tbody.innerHTML = "";
    state.items.forEach((it, idx) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td><input class="rowinput mono" value="${escapeHtml(it.date ?? "")}" data-k="date" data-i="${idx}"></td>
        <td><input class="rowinput" value="${escapeHtml(it.desc ?? "")}" data-k="desc" data-i="${idx}"></td>
        <td class="num"><input class="rowinput right mono" value="${escapeHtml(it.qty ?? "")}" data-k="qty" data-i="${idx}" inputmode="decimal"></td>
        <td class="num"><input class="rowinput right mono" value="${escapeHtml(it.unit ?? "")}" data-k="unit" data-i="${idx}" inputmode="decimal"></td>
        <td class="num"><input class="rowinput right mono" value="${escapeHtml(it.debit ?? "")}" data-k="debit" data-i="${idx}" inputmode="decimal"></td>
        <td class="num"><input class="rowinput right mono" value="${escapeHtml(it.credit ?? "")}" data-k="credit" data-i="${idx}" inputmode="decimal"></td>
        <td class="num">
          <input class="rowinput right mono" value="${escapeHtml(it.vatRate ?? 0)}" data-k="vatRate" data-i="${idx}" inputmode="decimal" title="MwSt % für diese Position">
        </td>
        <td class="toggle">
          <label style="margin:0;display:flex;align-items:center;gap:6px;">
            <input type="checkbox" ${it.vatEnabled ? "checked":""} data-k="vatEnabled" data-i="${idx}">
            <span class="hint">Ja</span>
          </label>
        </td>
        <td class="right"><button class="btn" type="button" data-del="${idx}">✕</button></td>
      `;
      tbody.appendChild(tr);
    });
    recalc();
  }

  tbody.addEventListener("input", (e) => {
    const el = e.target;
    if (!el.dataset || el.dataset.i === undefined) return;
    const i = parseInt(el.dataset.i, 10);
    const k = el.dataset.k;
    if (!state.items[i]) return;

    let v = el.value;

    if (["qty","unit","debit","credit","vatRate"].includes(k)){
      if (String(v).trim() === "") state.items[i][k] = "";
      else state.items[i][k] = toNumber(v);
    } else {
      state.items[i][k] = v;
    }
    recalc();
  });

  tbody.addEventListener("change", (e) => {
    const el = e.target;
    if (!el.dataset || el.dataset.i === undefined) return;
    const i = parseInt(el.dataset.i, 10);
    const k = el.dataset.k;
    if (!state.items[i]) return;

    if (k === "vatEnabled"){
      state.items[i].vatEnabled = !!el.checked;
      recalc();
    }
  });

  tbody.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-del]");
    if (!btn) return;
    const idx = parseInt(btn.dataset.del, 10);
    state.items.splice(idx, 1);
    renderItems();
  });

  document.getElementById("addRowBtn").addEventListener("click", () => {
    state.items.push({ date:"", desc:"", qty:"", unit:"", debit:"", credit:"", vatRate: 3.8, vatEnabled: true });
    renderItems();
  });

  // -----------------------------
  // Recalc totals + VAT breakdown per rate
  // -----------------------------
  function recalc(){
    // Auto-fill debit from qty*unit if debit & credit empty
    state.items = state.items.map(it => {
      const qty = toNumber(it.qty);
      const unit = toNumber(it.unit);
      const debit = it.debit === "" ? "" : toNumber(it.debit);
      const credit = it.credit === "" ? "" : toNumber(it.credit);

      if ((debit === "" || debit === 0) && (credit === "" || credit === 0) && qty > 0 && unit > 0){
        return { ...it, debit: round2(qty*unit) };
      }
      return it;
    });

    let totalDebit = 0;
    let totalCredit = 0;
    for (const it of state.items){
      totalDebit += (it.debit === "" ? 0 : toNumber(it.debit));
      totalCredit += (it.credit === "" ? 0 : toNumber(it.credit));
    }
    const balance = totalDebit - totalCredit;

    document.getElementById("totalDebit").textContent = fmt(totalDebit);
    document.getElementById("totalCredit").textContent = fmt(totalCredit);
    document.getElementById("balance").textContent = fmt(balance);
    document.getElementById("grandTotal").textContent = fmt(balance);

    // VAT breakdown by rate (assumes entered amounts are GROSS for taxable lines)
    const groups = new Map(); // rate -> { gross }
    for (const it of state.items){
      if (!it.vatEnabled) continue;
      const rate = toNumber(it.vatRate);
      if (rate <= 0) continue;

      const lineAmount = (it.debit === "" ? 0 : toNumber(it.debit)) - (it.credit === "" ? 0 : toNumber(it.credit));
      if (lineAmount === 0) continue;

      const prev = groups.get(rate) || { gross: 0 };
      prev.gross += lineAmount;
      groups.set(rate, prev);
    }

    const vatBody = document.querySelector("#vatBreakdownTable tbody");
    vatBody.innerHTML = "";

    const pVat = document.getElementById("p_vatRows");
    pVat.innerHTML = "";

    const rates = Array.from(groups.keys()).sort((a,b) => a-b);

    if (rates.length === 0){
      vatBody.innerHTML = `<tr><td class="muted" colspan="4">Keine MwSt-pflichtigen Positionen.</td></tr>`;
      pVat.innerHTML = `<tr><td class="muted" colspan="4" style="padding:6px 4px;">Keine MwSt.</td></tr>`;
    } else {
      for (const rate of rates){
        const gross = groups.get(rate).gross;
        const r = rate / 100;
        const net = gross / (1 + r);
        const vat = gross - net;

        vatBody.insertAdjacentHTML("beforeend", `
          <tr>
            <td class="mono">${rate.toFixed(1)}%</td>
            <td class="num mono">${fmt(net)}</td>
            <td class="num mono">${fmt(vat)}</td>
            <td class="num mono">${fmt(gross)}</td>
          </tr>
        `);

        pVat.insertAdjacentHTML("beforeend", `
          <tr>
            <td class="mono" style="padding:6px 4px;border-bottom:1px solid #eee;">${rate.toFixed(1)}%</td>
            <td class="num mono" style="padding:6px 4px;border-bottom:1px solid #eee;">${fmt(net)}</td>
            <td class="num mono" style="padding:6px 4px;border-bottom:1px solid #eee;">${fmt(vat)}</td>
            <td class="num mono" style="padding:6px 4px;border-bottom:1px solid #eee;">${fmt(gross)}</td>
          </tr>
        `);
      }
    }

    syncPrintable(totalDebit, totalCredit, balance);
  }

  // -----------------------------
  // Sync printable invoice
  // -----------------------------
  function syncPrintable(totalDebit, totalCredit, balance){
    setText("p_invoiceNo", v("invoiceNo") || "—");
    setText("p_invoiceDate", v("invoiceDate") || "—");
    setText("p_arrival", v("arrival") || "—");
    setText("p_departure", v("departure") || "—");
    setText("p_roomRes", v("roomReservation") || "—");
    setText("p_currency", v("currency") || "—");

    const sellerHeadMain = [ v("sellerName"), v("sellerAddressBlock") ].filter(Boolean).join("\n");
    setText("p_sellerHeadMain", sellerHeadMain);

    const sellerHeadContact = [ v("sellerContact"), v("sellerExtra") ].filter(Boolean).join(" | ");
    setText("p_sellerHeadContact", sellerHeadContact);

    const sellerBlock = [ v("sellerName"), v("sellerAddressBlock"), v("sellerContact"), v("sellerExtra") ].filter(Boolean).join("\n");
    setText("p_seller", sellerBlock);

    const buyerBlock = [ v("buyerName"), v("buyerAddressBlock") ].filter(Boolean).join("\n");
    setText("p_buyer", buyerBlock);

    setText("p_reference", v("reference") || "—");

    const pItems = document.getElementById("p_items");
    pItems.innerHTML = "";
    for (const it of state.items){
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="mono">${escapeHtml(it.date ?? "")}</td>
        <td>${escapeHtml(it.desc ?? "")}</td>
        <td class="num mono">${(it.qty === "" ? "" : toNumber(it.qty).toString())}</td>
        <td class="num mono">${(it.unit === "" ? "" : toNumber(it.unit).toFixed(2))}</td>
        <td class="num mono">${(it.debit === "" ? "" : fmt(toNumber(it.debit)))}</td>
        <td class="num mono">${(it.credit === "" ? "" : fmt(toNumber(it.credit)))}</td>
        <td class="num mono">${it.vatEnabled ? (toNumber(it.vatRate).toFixed(1) + "%") : "—"}</td>
      `;
      pItems.appendChild(tr);
    }

    setText("p_totalDebit", fmt(totalDebit));
    setText("p_totalCredit", fmt(totalCredit));
    setText("p_balance", fmt(balance));

    setText("p_legalFooter", v("legalFooter") || "");
  }

  function setText(id, val){
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent = val;
  }

  // keep printable in sync when fields change
  const headerInputs = [
    "sellerName","sellerContact","sellerExtra","sellerAddressBlock",
    "buyerName","buyerAddressBlock","reference",
    "invoiceNo","invoiceDate","currency",
    "arrival","departure","roomReservation",
    "legalFooter"
  ];
  headerInputs.forEach(id => {
    document.getElementById(id).addEventListener("input", recalc);
  });

  // -----------------------------
  // Print + PDF Export
  // -----------------------------
  document.getElementById("printBtn").addEventListener("click", () => {
    recalc();
    window.print();
  });

  document.getElementById("exportPdfBtn").addEventListener("click", async () => {
    try{
      recalc();
      const paper = document.getElementById("invoicePaper");

      const canvas = await html2canvas(paper, {
        scale: 2,
        useCORS: true,
        backgroundColor: "#ffffff"
      });

      const imgData = canvas.toDataURL("image/png");

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF("p", "mm", "a4");

      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();

      const imgProps = pdf.getImageProperties(imgData);
      const imgWidth = pageWidth;
      const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

      if (imgHeight <= pageHeight){
        pdf.addImage(imgData, "PNG", 0, 0, imgWidth, imgHeight);
      } else {
        let remaining = imgHeight;
        let position = 0;
        while (remaining > 0){
          pdf.addImage(imgData, "PNG", 0, position, imgWidth, imgHeight);
          remaining -= pageHeight;
          position -= pageHeight;
          if (remaining > 0) pdf.addPage();
        }
      }

      const inv = (v("invoiceNo") || "invoice").replace(/[^\w\-]+/g,"_");
      pdf.save(`Finale_Rechnung_${inv}.pdf`);
    } catch (err){
      console.error(err);
      alert("PDF Export fehlgeschlagen: " + (err?.message || err));
    }
  });

  // -----------------------------
  // JSON Import/Export
  // -----------------------------
  document.getElementById("exportJsonBtn").addEventListener("click", () => {
    const data = collectFormData();
    const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `invoice_editor_${(data.invoiceNo || "export")}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  });

  document.getElementById("importJson").addEventListener("change", async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    const text = await file.text();
    const data = JSON.parse(text);
    applyFormData(data);
    e.target.value = "";
  });

  function collectFormData(){
    return {
      sellerName: v("sellerName"),
      sellerContact: v("sellerContact"),
      sellerExtra: v("sellerExtra"),
      sellerAddressBlock: v("sellerAddressBlock"),

      buyerName: v("buyerName"),
      buyerAddressBlock: v("buyerAddressBlock"),

      reference: v("reference"),
      invoiceNo: v("invoiceNo"),
      invoiceDate: v("invoiceDate"),
      currency: v("currency"),
      arrival: v("arrival"),
      departure: v("departure"),
      roomReservation: v("roomReservation"),

      legalFooter: v("legalFooter"),
      items: state.items
    };
  }

  function applyFormData(d){
    if (!d) return;

    setV("sellerName", d.sellerName ?? "");
    setV("sellerContact", d.sellerContact ?? "");
    setV("sellerExtra", d.sellerExtra ?? "");
    setV("sellerAddressBlock", d.sellerAddressBlock ?? "");

    setV("buyerName", d.buyerName ?? "");
    setV("buyerAddressBlock", d.buyerAddressBlock ?? "");

    setV("reference", d.reference ?? "");
    setV("invoiceNo", d.invoiceNo ?? "");
    setV("invoiceDate", d.invoiceDate ?? "");
    setV("currency", d.currency ?? "CHF");
    setV("arrival", d.arrival ?? "");
    setV("departure", d.departure ?? "");
    setV("roomReservation", d.roomReservation ?? "");

    setV("legalFooter", d.legalFooter ?? "");

    state.items = Array.isArray(d.items) ? d.items : [];
    renderItems();
  }

  function v(id){ return document.getElementById(id).value; }
  function setV(id, val){ document.getElementById(id).value = val; }

  // -----------------------------
  // PDF Import (Text Extraction)
  // -----------------------------
  const pdfFileInput = document.getElementById("pdfFile");
  const extractedTextEl = document.getElementById("extractedText");

  function setupPdfJsWorker(){
    try{
      if (window.pdfjsLib && pdfjsLib.GlobalWorkerOptions){
        pdfjsLib.GlobalWorkerOptions.workerSrc =
          "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.worker.min.js";
        setPill("workerPill", "<b>PDF.js:</b> Worker (CDN)", "ok");
        return true;
      }
    } catch(_){}
    return false;
  }

  function ensurePdfJsReady(){
    if (!window.pdfjsLib){
      setPill("workerPill", "<b>PDF.js:</b> nicht geladen", "warn");
      alert("PDF.js konnte nicht geladen werden. Prüfe Internet/Adblocker.");
      return false;
    }
    if (!setupPdfJsWorker()){
      setPill("workerPill", "<b>PDF.js:</b> Fallback", "warn");
    }
    return true;
  }

  pdfFileInput.addEventListener("change", async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    if (!ensurePdfJsReady()){
      e.target.value = "";
      return;
    }

    setPill("importPill", `<b>Import:</b> ${escapeHtml(file.name)} …`, "");

    try{
      const buf = await file.arrayBuffer();
      const data = new Uint8Array(buf);

      let pdf;
      try{
        pdf = await pdfjsLib.getDocument({ data }).promise;
      } catch (err1){
        console.warn("Worker blocked, retry disableWorker", err1);
        pdf = await pdfjsLib.getDocument({ data, disableWorker: true }).promise;
        setPill("workerPill", "<b>PDF.js:</b> Worker deaktiviert (Fallback)", "warn");
      }

      let fullText = "";
      for (let p=1; p<=pdf.numPages; p++){
        const page = await pdf.getPage(p);
        const content = await page.getTextContent();
        const strings = content.items.map(it => it.str);
        fullText += strings.join("\n") + "\n";
      }

      fullText = normalizeText(fullText);

      // Debug output
      extractedTextEl.value = fullText;

      const parsed = parseInvoiceFromText(fullText);

      if (parsed){
        applyFormData(parsed);
        setPill("importPill", `<b>Import:</b> ${escapeHtml(file.name)} ✓`, "ok");
      } else {
        setPill("importPill", `<b>Import:</b> nichts erkannt`, "warn");
        alert("PDF importiert, aber Daten nicht erkannt. Bitte unten im „Import-Text“ prüfen (evtl. gescannt / anderer Aufbau).");
      }

    } catch(err){
      console.error(err);
      setPill("importPill", `<b>Import:</b> Fehler`, "warn");
      alert("PDF Import fehlgeschlagen: " + (err?.message || err));
    } finally {
      e.target.value = "";
    }
  });

  // -----------------------------
  // Robust parser
  // -----------------------------
  function parseInvoiceFromText(text){
    const out = collectFormData();
    const t = text || "";
    const upper = t.toUpperCase();

    // helper: find first match group
    const pick = (re) => {
      const m = t.match(re);
      return m ? (m[1] ?? "").trim() : "";
    };

    // invoice number (many variants)
    let invNo =
      pick(/\bInvoice\s*(?:No\.?|Number|N°|Nr\.?)\s*[:\-]?\s*([A-Z0-9\-\/]{3,})/i) ||
      pick(/\bINVOICE\s*(?:No\.?|NUMBER|N°|NR\.?)\s*[:\-]?\s*([A-Z0-9\-\/]{3,})/i);

    // invoice date variants: 05.01.2026 / 05/01/2026 / 2026-01-05
    let invDate =
      pick(/\b(?:Invoice\s*)?Date\s*[:\-]?\s*([0-9]{2}[.\/][0-9]{2}[.\/][0-9]{2,4})/i) ||
      pick(/\bDate\s*[:\-]?\s*([0-9]{4}-[0-9]{2}-[0-9]{2})/i);

    // arrival/departure
    let arrival =
      pick(/\bArrival\s*[:\-]?\s*([0-9]{2}[.\/][0-9]{2}[.\/][0-9]{2,4})/i) ||
      pick(/\bArriv(?:al|ée)?\s*[:\-]?\s*([0-9]{2}[.\/][0-9]{2}[.\/][0-9]{2,4})/i);
    let departure =
      pick(/\bDeparture\s*[:\-]?\s*([0-9]{2}[.\/][0-9]{2}[.\/][0-9]{2,4})/i) ||
      pick(/\bDepart(?:ure|ure|ure)?\s*[:\-]?\s*([0-9]{2}[.\/][0-9]{2}[.\/][0-9]{2,4})/i);

    // currency (try common codes)
    let currency =
      pick(/\b(Currency)\s*[:\-]?\s*([A-Z]{3})\b/i) ? (t.match(/\bCurrency\s*[:\-]?\s*([A-Z]{3})\b/i)[1]) : "" ;

    if (!currency){
      const m = upper.match(/\b(CHF|EUR|USD|GBP)\b/);
      if (m) currency = m[1];
    }

    // VAT default rate
    const vatMatch = t.match(/\bVAT\s*([0-9]+(?:[.,][0-9]+)?)\s*%/i);
    const defaultRate = vatMatch ? toNumber(vatMatch[1]) : 3.8;

    // Apply header fields if found
    if (invNo) out.invoiceNo = invNo;
    if (invDate) out.invoiceDate = invDate.replace(/\//g,".");
    if (arrival) out.arrival = arrival.replace(/\//g,".");
    if (departure) out.departure = departure.replace(/\//g,".");
    if (currency) out.currency = currency;

    // ---- Items parsing (robust) ----
    // We try multiple patterns:
    // A) Date + Description + Qty + Unit + Amount
    // B) Date + Description + Amount (qty/unit missing)
    // C) Lines where "X" appears: "2 X 135.00" then amount line
    const lines = t.split("\n").map(s => s.trim()).filter(Boolean);

    const items = [];
    const dateRe = /^(\d{2}[.\/]\d{2}[.\/](?:\d{2}|\d{4}))\s+(.*)$/;

    // helpers
    const normDate = (d) => d.replace(/\//g,".").replace(/^(\d{2}\.\d{2}\.)(\d{2})$/, "$120$2"); // 02.01.26 -> 02.01.2026
    const isCreditDesc = (desc) => /(deposit|advance|prepayment|transfer|paid|payment|voucher|refund|credit)/i.test(desc);
    const isCityTaxDesc = (desc) => /(city\s*tax|tourist\s*tax|taxe\s*de\s*s[eé]jour|kurtaxe)/i.test(desc);

    function pushItem({date, desc, qty, unit, debit, credit}){
      const city = isCityTaxDesc(desc);
      const creditLike = isCreditDesc(desc);
      const amount = toNumber(debit || credit || 0);

      items.push({
        date: date ? normDate(date) : "",
        desc: desc || "",
        qty: (qty === undefined ? "" : qty),
        unit: (unit === undefined ? "" : unit),
        debit: creditLike ? "" : (debit === "" ? "" : toNumber(debit)),
        credit: creditLike ? (credit === "" ? amount : toNumber(credit)) : (credit === "" ? "" : toNumber(credit)),
        vatRate: city ? 0.0 : defaultRate,
        vatEnabled: city ? false : true
      });
    }

    for (let i=0; i<lines.length; i++){
      const m = lines[i].match(dateRe);
      if (!m) continue;

      const date = m[1];
      const rest = m[2];

      // Pattern A: "...  2  135.00  270.00" (qty unit amount at end)
      // Take last 3 numbers as qty/unit/amount if plausible
      const nums = rest.match(/([0-9]+(?:[.,][0-9]+)?)/g) || [];
      if (nums.length >= 3){
        const last3 = nums.slice(-3).map(toNumber);
        const qty = last3[0];
        const unit = last3[1];
        const amount = last3[2];

        // heuristics: qty small-ish, unit > 0, amount > 0
        if (qty > 0 && qty < 10000 && unit > 0 && amount !== 0){
          const desc = rest.replace(/([0-9]+(?:[.,][0-9]+)?\s*){3}$/, "").trim();
          const creditLike = isCreditDesc(desc);
          pushItem({
            date, desc,
            qty,
            unit,
            debit: creditLike ? "" : amount,
            credit: creditLike ? amount : ""
          });
          continue;
        }
      }

      // Pattern B: "...  270.00" (only amount at end)
      const lastNum = rest.match(/([0-9]+(?:[.,][0-9]+)?)\s*$/);
      if (lastNum){
        const amount = toNumber(lastNum[1]);
        if (amount !== 0){
          const desc = rest.replace(/([0-9]+(?:[.,][0-9]+)?)\s*$/, "").trim();
          const creditLike = isCreditDesc(desc);
          pushItem({
            date, desc,
            qty: "",
            unit: "",
            debit: creditLike ? "" : amount,
            credit: creditLike ? amount : ""
          });
          continue;
        }
      }

      // Pattern C: next lines have "2 X 135.00" then "… 270.00"
      const m2 = (lines[i+1] || "").match(/^(\d+(?:[.,]\d+)?)\s*[xX]\s*([0-9]+(?:[.,][0-9]+)?)$/);
      const m3 = (lines[i+2] || "").match(/([0-9]+(?:[.,][0-9]+)?)\s*$/);
      if (m2 && m3){
        const qty = toNumber(m2[1]);
        const unit = toNumber(m2[2]);
        const amount = toNumber(m3[1]);
        const desc = rest.trim();
        const creditLike = isCreditDesc(desc);
        pushItem({
          date, desc,
          qty,
          unit,
          debit: creditLike ? "" : amount,
          credit: creditLike ? amount : ""
        });
        i += 2;
        continue;
      }
    }

    if (items.length) out.items = items;

    // if nothing meaningful recognized, return null so UI warns
    const hasAnything =
      !!out.invoiceNo || !!out.invoiceDate || (out.items && out.items.length > 0);

    return hasAnything ? out : null;
  }

  // -----------------------------
  // Init
  // -----------------------------
  (function init(){
    if (window.pdfjsLib){
      try{
        pdfjsLib.GlobalWorkerOptions.workerSrc =
          "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.worker.min.js";
        setPill("workerPill", "<b>PDF.js:</b> Worker (CDN)", "ok");
      } catch {
        setPill("workerPill", "<b>PDF.js:</b> Fallback", "warn");
      }
    } else {
      setPill("workerPill", "<b>PDF.js:</b> lädt…", "");
    }
    setPill("importPill", "<b>Import:</b> bereit", "");
    renderItems();
    recalc();
  })();
</script>
</body>
</html>
